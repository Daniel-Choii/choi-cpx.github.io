<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="1ë¶„ CPX">
    <meta name="author" content="KNU FM JSW">
    <meta name="description" content="ì˜ì‚¬ êµ­ê°€ê³ ì‹œ ì‹¤ê¸°(CPX) ëŒ€ë¹„ë¥¼ ìœ„í•œ 1ë¶„ íƒ€ì´ë¨¸ ë° ì¼€ì´ìŠ¤ ìŠ¤í„°ë”” ì›¹ì•±.">
    <meta property="og:title" content="1ë¶„ CPX - ì‹¤ê¸°ì‹œí—˜ ìˆœë°œë ¥ í›ˆë ¨">
    <meta property="og:description" content="C.Cë¥¼ ë³´ê³  1ë¶„ ì•ˆì— ì—°ìƒí•˜ëŠ” ì‹¤ì „ ê°ê° ì—°ìŠµ. ì œì‘: KNU FM JSW">

    <title>1ë¶„ CPX v1.2</title>
    
    
    <link rel="apple-touch-icon" href="icon.PNG">
    <link rel="icon" type="image/png" href="icon.PNG">
    
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #334155;
            --primary-color: #2563eb;
            --timer-bg: #fff7ed;
            --timer-text: #c2410c;
            --timer-border: #fed7aa;
            --header-height: 60px;
            --box-bg: #f1f5f9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: "Pretendard", "Malgun Gothic", "Apple SD Gothic Neo", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; flex-direction: column;
            height: 100vh; height: 100dvh; overflow: hidden; user-select: none;
        }

        .container {
            max-width: 500px; margin: 0 auto; width: 100%; height: 100%;
            background-color: white; display: flex; flex-direction: column; position: relative;
        }

        /* âœ… [ìˆ˜ì •ë¨] íŒŒìŠ¤í…” í†¤ í˜•ê´‘íœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .hl-btn {
            width: 24px; 
            height: 24px;
            border-radius: 4px; /* ì•½ê°„ ë‘¥ê·¼ ì‚¬ê°í˜• */
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1); /* ì€ì€í•œ í…Œë‘ë¦¬ */
            margin-left: 4px;
            transition: transform 0.1s, border-color 0.1s;
        }
        .hl-btn:active { transform: scale(0.9); }
        
        /* ë…¸ë€ìƒ‰ ë²„íŠ¼ (íŒŒìŠ¤í…”) */
        .hl-btn.yellow { 
            background-color: #fff9c4; /* ì—°í•œ ë…¸ë‘ */
            border-color: #fbc02d;     /* ì§„í•œ ë…¸ë‘ í…Œë‘ë¦¬ */
        }
        /* ì—°ë‘ìƒ‰ ë²„íŠ¼ (íŒŒìŠ¤í…”) */
        .hl-btn.green { 
            background-color: #dcedc8; /* ì—°í•œ ì—°ë‘ */
            border-color: #8bc34a;     /* ì§„í•œ ì—°ë‘ í…Œë‘ë¦¬ */
        }

        /* HEADER */
        header {
            padding: 0 1rem; padding-top: env(safe-area-inset-top);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
            background-color: white; z-index: 10; height: calc(var(--header-height) + env(safe-area-inset-top));
        }
        
        .header-left { display: flex; align-items: center; gap: 0.8rem; }
        .brand-box { display: flex; flex-direction: column; justify-content: center; cursor: pointer; }
        .main-title { 
            font-weight: 900; 
            font-size: 1rem;       /* 1. í°íŠ¸ í¬ê¸° ì¶•ì†Œ (1.1rem -> 1rem) */
            color: #1e293b; 
            letter-spacing: -0.5px;
            white-space: nowrap;   /* 2. ì¤„ë°”ê¿ˆ ê°•ì œ ë°©ì§€ (í•µì‹¬) */
        }
        .sub-title { font-weight: 700; font-size: 0.65rem; color: var(--primary-color); letter-spacing: 0.5px; }

        .timer-badge {
            display: flex; align-items: center; gap: 0.3rem;
            background-color: var(--timer-bg); padding: 0.3rem 0.6rem; border-radius: 99px;
            font-size: 0.9rem; font-weight: 800; color: var(--timer-text); 
            cursor: pointer; border: 1px solid var(--timer-border); transition: 0.3s;
        }
        .timer-badge:active { transform: scale(0.95); }
        .timer-badge.urgent {
            background-color: #fee2e2; color: #ef4444; border-color: #fca5a5;
            animation: heartBeat 1s infinite;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.1); }
            30% { transform: scale(1); }
            45% { transform: scale(1.1); }
            60% { transform: scale(1); }
        }

        .header-controls { display: flex; gap: 0.3rem; align-items: center; }
        .header-btn {
            background: none; border: none; padding: 0.5rem; cursor: pointer; color: #94a3b8;
            border-radius: 8px; font-weight: 700; font-size: 0.85rem;
            display: flex; align-items: center; gap: 0.3rem;
            
            /* âœ… í•µì‹¬ ìˆ˜ì •: PCì—ì„œë„ ì ˆëŒ€ ì¤„ë°”ê¿ˆ ê¸ˆì§€ & ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
            white-space: nowrap; 
            flex-shrink: 0;
        }
        .header-btn svg { width: 1.1rem; height: 1.1rem; stroke-width: 2.5; }
        .header-btn.active { color: var(--primary-color); background: #eff6ff; }
        
        .icon-control-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #cbd5e1; cursor: pointer;
            transition: 0.2s;
        }
        .icon-control-btn.active { background: #eff6ff; color: var(--primary-color); border-color: #bfdbfe; }
        .icon-control-btn:active { transform: scale(0.95); }
        .icon-control-btn svg { width: 1.3rem; height: 1.3rem; }

        /* VIEW CONTAINERS */
        .view-section { flex: 1; display: none; flex-direction: column; overflow: hidden; position: relative; background: #f8fafc; }
        .view-section.active { display: flex; }

        /* STUDY VIEW */
        .progress-bar-area { width: 100%; height: 4px; background: #e2e8f0; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .progress-float { 
            position: absolute; top: 1rem; right: 1.5rem; font-size: 0.8rem; 
            font-weight: 800; color: #cbd5e1; z-index: 5;
        }

        .card-area {
            flex: 1; padding: 1.5rem; display: flex; align-items: center; justify-content: center;
            perspective: 1000px; position: relative;
        }
        
        /* SHAKE ANIMATION */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .shaking {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        .card-wrapper {
            width: 100%; height: 100%; max-height: 680px; position: relative;
            transform-style: preserve-3d; transition: transform 0.4s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        .card-wrapper.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 20px; box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #e2e8f0; background: white;
        }

        /* FRONT SIDE */
        .card-front { 
            padding: 2rem; z-index: 2; display: flex; flex-direction: column; gap: 1.2rem; align-items: flex-start; 
            overflow-y: auto;
        }
        
        .topic-badge {
            display: inline-block; padding: 6px 14px; background: #eff6ff; color: #2563eb;
            border-radius: 20px; font-size: 0.85rem; font-weight: 800; margin-bottom: 0.5rem;
        }

        .info-box {
            width: 100%; background-color: var(--box-bg); border-radius: 12px; padding: 1.2rem;
            display: flex; flex-direction: column; gap: 0.5rem; border: 1px solid #e2e8f0;
        }

        .info-label { font-size: 0.8rem; font-weight: 800; color: #64748b; margin-bottom: 0.2rem; }
        .info-content { font-size: 1.15rem; font-weight: 700; color: #1e293b; line-height: 1.5; word-break: keep-all; }

        .vitals-container { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .vital-item { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; flex: 1; }
        .vital-label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; }
        .vital-value { font-size: 1.1rem; font-weight: 800; color: #334155; }
        .vital-item:not(:last-child) { border-right: 1px solid #e2e8f0; }

        .instruction-list { padding-left: 1.2rem; margin: 0; font-size: 1rem; font-weight: 500; color: #475569; line-height: 1.6; }
        .instruction-list li { margin-bottom: 4px; }
        .instruction-list li.hybrid-skill { color: #2563eb; font-weight: 700; background: #eff6ff; padding: 2px 6px; border-radius: 4px; }

        .touch-hint {
            margin-top: auto; width: 100%; text-align: center; color: #94a3b8;
            font-size: 0.85rem; font-weight: 600; padding-top: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 0.3rem;
        }
        @media (max-width: 768px) { .pc-hint { display: none; } }

        /* BACK SIDE */
        .card-back { background: #fff; transform: rotateY(180deg); display: flex; flex-direction: column; }
        
        .back-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.8rem 1rem; border-bottom: 1px solid #f1f5f9; background: #fff;
        }
        .nav-btn {
            background: #f1f5f9; border: none; border-radius: 8px; 
            padding: 0.5rem 0.8rem; font-size: 0.9rem; font-weight: 700; color: #475569;
            display: flex; align-items: center; gap: 0.3rem; cursor: pointer;
        }
        .tool-btns { display: flex; gap: 0.5rem; }
        .icon-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: 1px solid #e2e8f0; color: #64748b;
            background: white; cursor: pointer;
        }
        .icon-btn.delete { color: #ef4444; background: #fef2f2; border-color: #fee2e2; }

        .cpx-form { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .field-group { border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; }
        .field-header { display: flex; align-items: center; cursor: pointer; padding: 0.5rem 0; }
        .field-label { width: 50px; font-size: 0.95rem; font-weight: 800; color: var(--primary-color); flex-shrink: 0; }
        .field-key { flex: 1; font-size: 1rem; font-weight: 600; color: #1e293b; }
        .field-key.empty { color: #cbd5e1; font-weight: 400; font-size: 0.9rem; }
        .explanation-box {
            background: #f8fafc; padding: 1rem; border-radius: 8px; margin-left: 50px; margin-bottom: 0.5rem;
            font-size: 0.95rem; line-height: 1.6; color: #334155; display: none; cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        .explanation-box.show { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* CONTROLS (FOOTER) */
        .controls { 
            padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            border-top: 1px solid #e2e8f0; background: white; z-index: 20;
        }
        
        .nav-row { display: flex; gap: 0.8rem; align-items: center; width: 100%; }
        .btn {
            border-radius: 12px; font-size: 1.1rem; font-weight: 700;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            background: var(--primary-color); color: white; transition: 0.2s; padding: 1rem;
        }
        .btn-nav { width: 3.5rem; flex-shrink: 0; background: #f1f5f9; color: #64748b; font-size: 1.2rem; }
        .btn-nav:active { background: #e2e8f0; transform: scale(0.95); }
        .btn-main { flex: 1; }
        .btn-red { background: #fee2e2; color: #b91c1c; }
        .btn-green { background: #dcfce7; color: #166534; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; width: 100%; }

        /* MANAGER VIEW */
        .list-container { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 6rem; }
        .list-action-bar { 
            padding: 0.8rem 1rem; background: #fff; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem;
        }
        .category-section { margin-bottom: 1rem; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .category-header {
            padding: 1rem; font-weight: 700; color: #334155; font-size: 1rem;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff;
        }
        .category-header:active { background: #f8fafc; }
        .category-list { display: block; border-top: 1px solid #f1f5f9; }
        .category-list.collapsed { display: none; }
        
        .list-item {
            padding: 0.8rem 1rem; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item.hidden .title { color: #94a3b8; text-decoration: line-through; }
        .item-left { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px; font-weight: 600; color: #334155; }
        .item-right { display: flex; align-items: center; gap: 0.8rem; flex-shrink: 0; }
        
        .score-badge { 
            font-size: 0.8rem; font-weight: 800; padding: 4px 8px; border-radius: 8px; 
            min-width: 30px; text-align: center;
        }
        .score-green { background: #dcfce7; color: #166534; }
        .score-yellow { background: #fef9c3; color: #854d0e; }
        .score-red { background: #fee2e2; color: #b91c1c; }
        .score-gray { background: #f1f5f9; color: #94a3b8; }

        .list-actions { display: flex; gap: 0.3rem; }
        .icon-action-btn {
            background: none; border: 1px solid #e2e8f0; border-radius: 8px;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #94a3b8;
        }
        .icon-action-btn.active { background: #eff6ff; color: var(--primary-color); border-color: var(--primary-color); }
        .icon-action-btn.edit { color: #64748b; background: #f8fafc; }

        .manager-controls {
            display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 0.5rem; 
            padding-top: 1rem; border-top: 1px solid #e2e8f0; margin-top: 1rem;
        }
        .btn-blue-outline { background: white; border: 1px solid #bfdbfe; color: var(--primary-color); font-size: 1rem; padding: 0.8rem; }
        .btn-reset-outline { 
            background: white; border: 1px solid #fee2e2; color: #ef4444; font-size: 1rem; padding: 0.8rem; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* QUIZ MODE UI */
        .mock-setup-container { padding: 1.5rem; flex: 1; overflow-y: auto; }
        .mock-title { font-size: 1.2rem; font-weight: 900; margin-bottom: 1rem; color: #1e293b; }
        .num-input-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .num-input { 
            width: 80px; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1.1rem; font-weight: 700; text-align: center; 
        }
        .tree-container { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .tree-header { padding: 0.8rem 1rem; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .tree-content { max-height: 400px; overflow-y: auto; }
        .tree-cat { border-bottom: 1px solid #f1f5f9; }
        .tree-cat-head { padding: 0.8rem 1rem; display: flex; align-items: center; gap: 0.5rem; background: white; cursor: pointer; }
        .tree-cat-head label { flex: 1; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
        .tree-items { display: none; padding-left: 2rem; border-top: 1px solid #f1f5f9; background: #f8fafc; }
        .tree-items.open { display: block; }
        .tree-item { padding: 0.6rem 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid #f1f5f9; }
        .tree-item label { font-size: 0.9rem; color: #475569; cursor: pointer; }

        .result-card { background: white; border-radius: 16px; padding: 2rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        .result-score { font-size: 3.5rem; font-weight: 900; color: var(--primary-color); margin: 0.5rem 0; line-height: 1; }
        .result-msg { font-size: 1rem; font-weight: 700; color: #64748b; margin-bottom: 1.5rem; }
        .result-list { text-align: left; background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 1rem; }
        .result-item { padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; gap: 0.8rem; align-items: center; cursor: pointer; }
        .result-item:active { background: #f8fafc; }
        .res-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 800; min-width: 30px; text-align: center; }
        .res-o { background: #dcfce7; color: #166534; }
        .res-x { background: #fee2e2; color: #b91c1c; }

        /* MODALS & TOAST */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: white; width: 100%; height: 85%;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;
            padding-bottom: env(safe-area-inset-bottom);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        #manager-preview-modal { z-index: 60; }
        #input-modal { z-index: 70; }
        
        /* ONBOARDING MODAL */
        #onboarding-modal { z-index: 999; align-items: center; justify-content: center; }
        #onboarding-modal .modal-content {
            width: 90%; height: auto; max-height: 80%;
            border-radius: 20px; padding: 0; overflow: hidden;
        }
        .onboarding-slider { flex: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .onboarding-slide { 
            flex: 0 0 100%; width: 100%; padding: 2rem 1.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            scroll-snap-align: center;
        }
        .slide-icon { margin-bottom: 1.5rem; }
        .slide-icon svg { width: 5rem; height: 5rem; }
        
        .slide-title { font-size: 1.3rem; font-weight: 900; color: #1e293b; margin-bottom: 1rem; line-height: 1.3; }
        .slide-desc { font-size: 0.95rem; color: #475569; line-height: 1.6; word-break: keep-all; }
        
        .warn-box {
            background: #fef2f2; border: 1px solid #fee2e2; border-radius: 12px; padding: 0.8rem;
            margin-top: 1rem; font-size: 0.85rem; color: #b91c1c; text-align: left; line-height: 1.4;
        }
        .tip-box {
            background: #fffbeb; border: 1px solid #fcd34d; border-radius: 12px; padding: 0.8rem;
            margin-top: 1rem; font-size: 0.85rem; color: #92400e; text-align: left; line-height: 1.4;
        }
        /* ë‹«ê¸° ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •) */
        .onboarding-close {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem; color: #94a3b8;
            cursor: pointer; z-index: 10; padding: 0.5rem; line-height: 1;
        }
        .onboarding-nav { 
            padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; 
        }
        .dots { display: flex; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #e2e8f0; transition: 0.3s; }
        .dot.active { background: var(--primary-color); width: 20px; border-radius: 10px; }

        /* EDIT HELP OVERLAY */
        #edit-help-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 80; display: none; flex-direction: column;
            padding: 2rem; color: white;
        }
        .edit-help-arrow { font-size: 2rem; margin-bottom: 0.5rem; color: #fbbf24; }
        .edit-help-text { font-size: 1rem; font-weight: 600; line-height: 1.5; margin-bottom: 2rem; }

        .chip-container { display: flex; gap: 0.5rem; padding: 0 1rem; padding-top: 1rem; flex-wrap: wrap; }
        .field-chip { 
            padding: 6px 12px; border-radius: 20px; border: 1px solid #cbd5e1; background: white; 
            font-size: 0.85rem; font-weight: 700; color: #94a3b8; cursor: pointer; 
        }
        .field-chip.active { background: #eff6ff; color: var(--primary-color); border-color: var(--primary-color); }

        .toast-container {
            position: absolute; bottom: 6rem; left: 0; width: 100%;
            display: flex; justify-content: center; pointer-events: none; z-index: 100;
        }
        .toast {
            background: rgba(30, 41, 59, 0.9); color: white; padding: 0.8rem 1.5rem;
            border-radius: 99px; font-weight: 600; font-size: 0.9rem;
            opacity: 0; transform: translateY(10px); transition: 0.3s;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        .editor-toolbar {
            display: flex; gap: 0.5rem; padding: 0.8rem 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; overflow-x: auto;
        }
        .tool-btn {
            padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; 
            font-weight: 700; font-size: 0.9rem; cursor: pointer; min-width: 36px;
        }
        .color-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #e2e8f0; cursor: pointer; }
        .color-btn.black { background: #1e293b; }
        .color-btn.red { background: #ef4444; }
        .color-btn.blue { background: #2563eb; }
        .rich-editor {
            width: 100%; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px;
            font-size: 1rem; font-family: inherit; resize: none; min-height: 2.5rem;
            outline: none; line-height: 1.5; color: #334155;
        }
        .rich-editor:focus { border-color: var(--primary-color); background: #f8fafc; }
        .rich-editor.detail { flex: 1; overflow-y: auto; }
        .timer-option-btn {
            width: 100%; padding: 1rem; margin-bottom: 0.5rem;
            border: 1px solid #e2e8f0; border-radius: 12px;
            background: white; color: #1e293b; font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }

        /* --- ğŸ“± ëª¨ë°”ì¼ ì „ìš© ìµœì í™” (í…ìŠ¤íŠ¸ ìœ ì§€ & ì¤„ë°”ê¿ˆ ë°©ì§€ ë²„ì „) --- */
        @media (max-width: 768px) {
            html { font-size: 14px; }
            
            /* 1. í—¤ë” ì „ì²´ ê³µê°„ í™•ë³´ */
            header { 
                height: calc(54px + env(safe-area-inset-top)); 
                padding: 0 0.5rem; /* ì¢Œìš° ì—¬ë°± ìµœì†Œí™” */
                padding-top: env(safe-area-inset-top);
                gap: 0.3rem; /* ë¡œê³ ì™€ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© ì¢í˜ */
            }
            
            /* 2. ì™¼ìª½ ë¸Œëœë“œ ë¡œê³  ë‹¤ì´ì–´íŠ¸ */
            .brand-box .main-title { font-size: 0.9rem; white-space: nowrap; } 
            .brand-box .sub-title { display: none; } /* ë²„ì „ ì •ë³´(v1.2)ëŠ” ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ìˆ¨ê¹€ */
            .timer-badge { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
            .timer-badge svg { width: 0.9rem; height: 0.9rem; } /* ì‹œê³„ ì•„ì´ì½˜ ì¶•ì†Œ */

            /* 3. ì˜¤ë¥¸ìª½ ë²„íŠ¼ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
            .header-controls { gap: 0.2rem; } /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© ì¢í˜ */

            /* 4. ë¦¬ì…‹, ì…”í”Œ ì•„ì´ì½˜ ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
            .icon-control-btn { 
                width: 28px; height: 28px; /* í¬ê¸° ì¤„ì„ */
                padding: 0;
            }
            .icon-control-btn svg { width: 1rem; height: 1rem; }

            /* 5. í•µì‹¬: í•™ìŠµ/í€´ì¦ˆ/ëª©ë¡ ë²„íŠ¼ ìµœì í™” */
            .header-btn {
                font-size: 0.75rem !important; /* ê¸€ì í¬ê¸° ì‚´ì§ ì¤„ì„ */
                padding: 0.4rem 0.5rem; /* ë‚´ë¶€ ì—¬ë°± íƒ€ì´íŠ¸í•˜ê²Œ */
                gap: 0.2rem; /* ì•„ì´ì½˜ê³¼ ê¸€ì ì‚¬ì´ ê°„ê²© ì¢í˜ */
                white-space: nowrap; /* ğŸš¨ ì ˆëŒ€ ì¤„ë°”ê¿ˆ í•˜ì§€ ë§ˆë¼ (ê°•ì œ) */
                border-radius: 6px;
            }
            .header-btn svg {
                width: 0.9rem; height: 0.9rem; /* ë²„íŠ¼ ë‚´ ì•„ì´ì½˜ ì¶•ì†Œ */
            }

            /* ë‚˜ë¨¸ì§€ ì¹´ë“œ ë° í•˜ë‹¨ UI ìµœì í™” */
            .card-front { padding: 1.2rem 0.8rem; gap: 0.6rem; }
            .info-box { padding: 0.7rem; gap: 0.2rem; }
            .info-content { font-size: 1.1rem; line-height: 1.4; }
            .vitals-container { gap: 0.2rem; }
            .vital-value { font-size: 1rem; }
            .vital-label { font-size: 0.7rem; }
            .controls { padding: 0.6rem; padding-bottom: calc(0.6rem + env(safe-area-inset-bottom)); }
            .btn { padding: 0.7rem; font-size: 1rem; border-radius: 10px; }
            .list-item { padding: 0.6rem 0.5rem; min-height: 48px; }
            .category-header { padding: 0.8rem; }
            }
            /* âœï¸ ì‘ì„±ëœ ë‚´ìš©ì´ ìˆì„ ë•Œ ì—°í•„ ìƒ‰ìƒ ë³€ê²½ (íŒŒë€ìƒ‰) */
            .icon-action-btn.filled { 
                background: #eff6ff; 
                color: #2563eb; 
                border-color: #bfdbfe; 
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <div class="brand-box" onclick="switchMode('manager')" style="flex-direction:row; align-items:center; gap:0.6rem;">
                <img src="icon.PNG" style="width:2.2rem; height:2.2rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <span class="main-title">1ë¶„ CPX</span>
                    <span class="sub-title">v1.2</span>
                </div>
            </div>

            <div id="timer-badge" class="timer-badge" onclick="openTimerModal()">
                <svg style="width:1.2rem; height:1.2rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span id="timer-text">60</span>
            </div>
        </div>
        <div class="header-controls">
            <button class="icon-control-btn" id="btn-reset" onclick="startSession('reset')" style="margin-right:0.3rem;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
            <button class="icon-control-btn" id="btn-shuffle" onclick="toggleShuffle()" style="margin-right:0.3rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
            </button>
            <button class="header-btn active" id="btn-mode-study" onclick="switchMode('study')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                í•™ìŠµ
            </button>
            <button class="header-btn" id="btn-mode-mock" onclick="switchMode('mock-setup')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><circle cx="15.5" cy="15.5" r="1.5"></circle></svg>
                í€´ì¦ˆ
            </button>
            <button class="header-btn" id="btn-mode-list" onclick="switchMode('manager')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                ëª©ë¡
            </button>
        </div>
    </header>

    <div id="study-view" class="view-section active">
        <div class="progress-bar-area"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="progress-float" id="progress-text">0 / 0</div>

        <div class="card-area">
            <div class="card-wrapper" id="card-wrapper">
                <div class="card-face card-front" id="card-front" onclick="flipCard(true)"></div>
                <div class="card-face card-back">
                    <div class="back-header">
                        <button class="nav-btn" onclick="flipCard(false)">ë¬¸ì œ ë³´ê¸°</button>
                        <div class="tool-btns">
                            <button class="icon-btn" onclick="hideCurrentCard()"><svg style="width:1.5rem; height:1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg></button>
                        </div>
                    </div>
                    <div class="cpx-form" id="card-back-form"></div>
                </div>
            </div>
            <div id="empty-state" style="display:none; text-align:center; color:#64748b; padding-top:2rem;">
                <svg style="width:3rem; height:3rem; margin-bottom:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 style="color:#1e293b; margin-bottom:0.5rem;">í•™ìŠµ ì¢…ë£Œ</h3>
                <p>ëª¨ë“  ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</p>
                <button class="btn" style="width:auto; display:inline-block; margin-top:1rem;" onclick="startSession('all')">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
            </div>
        </div>

        <div class="controls">
            <div class="nav-row" id="front-nav">
                <button class="btn btn-nav" onclick="prevCard()">&lt;</button>
                <button class="btn btn-main" onclick="flipCard(true)">ì •ë‹µ í™•ì¸</button>
                <button class="btn btn-nav" onclick="nextCard()">&gt;</button>
            </div>
            <div class="btn-group" id="answer-btns" style="display:none;">
                <button class="btn btn-red" onclick="handleAnswer(false)">â† ëª°ëì–´ìš”</button>
                <button class="btn btn-green" onclick="handleAnswer(true)">ì•Œì•„ìš” â†’</button>
            </div>
            <div class="btn-group" id="review-nav" style="display:none;">
                <button class="btn" style="grid-column: span 2;" onclick="returnToResults()">ğŸ”™ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
        <div class="toast-container"><div id="toast" class="toast">ë©”ì‹œì§€</div></div>
    </div>

    <div id="mock-setup-view" class="view-section" style="background:#fff;">
        <div class="mock-setup-container">
            <div class="mock-title">í€´ì¦ˆ ì„¤ì •</div>
            <div class="num-input-row">
                <span style="font-weight:700; font-size:1rem; color:#475569;">ë¬¸ì œ ìˆ˜</span>
                <input type="number" id="mock-num" class="num-input" value="5" min="1" max="48">
                <span style="font-size:0.9rem; color:#94a3b8;">(ë‹¨ì›ë³„ 1ë¬¸ì œ ìš°ì„  ì¶œì œ)</span>
            </div>
            
            <div class="tree-container">
                <div class="tree-header">
                    <span>ì¶œì œ ë²”ìœ„ ì„ íƒ</span>
                    <button class="btn" style="padding:0.3rem 0.8rem; font-size:0.8rem; width:auto; height:auto;" onclick="toggleAllMockTree()">ì „ì²´ ì„ íƒ/í•´ì œ</button>
                </div>
                <div class="tree-content" id="mock-tree-root"></div>
            </div>
        </div>
        <div class="controls">
            <button class="btn" onclick="startMockExam()">í€´ì¦ˆ ì‹œì‘</button>
        </div>
    </div>

    <div id="mock-result-view" class="view-section" style="background:#f1f5f9; padding:1.5rem; overflow-y:auto;">
        <div class="result-card">
            <div style="font-size:1rem; font-weight:700; color:#64748b;">ì˜¤ëŠ˜ì˜ ê²°ê³¼</div>
            <div class="result-score" id="result-score-text">0 / 0</div>
            <div class="result-msg" id="result-msg">ì˜í–ˆì–´ìš”!</div>
            <div id="retry-wrong-btn-area" style="display:none; margin-bottom:1rem;">
                <button class="btn btn-red" style="width:100%; padding:0.8rem;" onclick="retryWrongAnswers()">
                    âŒ í‹€ë¦° ë¬¸ì œë§Œ ë‹¤ì‹œ í•˜ê¸°
                </button>
            </div>
            <p style="color:#94a3b8; font-size:0.85rem;">ë¬¸ì œë¥¼ í„°ì¹˜í•˜ë©´ í•´ë‹¹ ì¹´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤</p>
        </div>
        <div class="result-list" id="result-list"></div>
        <div style="margin-top:auto; padding-bottom:2rem;">
            <button class="btn" onclick="switchMode('mock-setup')">ìƒˆë¡œìš´ í€´ì¦ˆ í•˜ê¸°</button>
        </div>
    </div>

    <div id="manager-view" class="view-section">
        <div class="list-action-bar">
            <button class="btn" style="width:auto; padding:0.4rem 0.8rem; font-size:0.85rem;" onclick="showOnboarding(true)">
                ğŸ’¡ ë„ì›€ë§
            </button>
            <button class="btn" style="width:auto; padding:0.4rem 0.8rem; font-size:0.85rem;" id="btn-toggle-all" onclick="toggleAllCards()">
                â˜‘ï¸ ì „ì²´ ì„ íƒ/í•´ì œ
            </button>
        </div>
        <div class="list-container" id="list-container"></div>      

        <div class="controls" style="background:white; display:block; padding:0; border-top:1px solid #e2e8f0;">
            <details style="width:100%;">
                <summary style="padding:1rem; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; font-weight:700; color:#475569; background:#f8fafc;">
                    <span>âš™ï¸ ë°ì´í„° ê´€ë¦¬ / ë°±ì—… ì„¤ì •</span>
                    <span style="font-size:0.8rem; color:#94a3b8;">â–¼</span>
                </summary>
                
                <div style="padding:1rem; background:white; border-top:1px solid #f1f5f9;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; margin-bottom:1rem;">
                        <button class="btn btn-blue-outline" onclick="exportDataToClipboard()" style="font-size:0.9rem; padding:0.8rem;">
                            ğŸ“¤ ë³µì‚¬ (ë‚´ë³´ë‚´ê¸°)
                        </button>
                        <button class="btn btn-blue-outline" onclick="importDataFromClipboard()" style="font-size:0.9rem; padding:0.8rem;">
                            ğŸ“¥ ë¶™ì—¬ë„£ê¸° (ê°€ì ¸ì˜¤ê¸°)
                        </button>
                    </div>
                    
                    <details>
                        <summary style="cursor:pointer; color:#94a3b8; font-size:0.8rem; margin-bottom:0.5rem; text-align:right;">ìˆ˜ë™ ì…ë ¥ì°½ ì—´ê¸° â–¼</summary>
                        <textarea id="import-text-area" class="rich-editor" style="min-height:80px; font-size:0.8rem; width:100%;" placeholder="ì—¬ê¸°ì— ë°±ì—… ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
                        <button class="btn" style="margin-top:0.5rem; padding:0.6rem; font-size:0.9rem; width:100%;" onclick="importFromTextArea()">
                            í…ìŠ¤íŠ¸ë¡œ ë³µì›í•˜ê¸°
                        </button>
                    </details>

                    <div style="margin-top:1.5rem; border-top:1px solid #f1f5f9; padding-top:1rem;">
                        <button class="btn btn-reset-outline" style="width:100%; padding:0.8rem;" onclick="resetData()">
                            ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </details>
        </div>
    </div>
    
    <div class="modal-overlay" id="input-modal">
        <div class="modal-content">
            <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700;">ë‚´ìš© í¸ì§‘</span>
                <button onclick="closeModal()" style="font-size:1.5rem; background:none; border:none;">&times;</button>
            </div>
            <div class="editor-toolbar">
                <button class="tool-btn" onmousedown="event.preventDefault(); execCmd('bold')">B</button>
                <button class="tool-btn" onmousedown="event.preventDefault(); execCmd('italic')"><i>I</i></button>
                <button class="tool-btn" onmousedown="event.preventDefault(); execCmd('underline')"><u>U</u></button>
                <div style="width:1px; background:#cbd5e1; margin:0 5px;"></div>
                <button class="color-btn black" onmousedown="event.preventDefault(); execColor('#334155')"></button>
                <button class="color-btn red" onmousedown="event.preventDefault(); execColor('#ef4444')"></button>
                <button class="color-btn blue" onmousedown="event.preventDefault(); execColor('#2563eb')"></button>
                <div style="width:1px; background:#cbd5e1; margin:0 5px;"></div>
                
                <button class="hl-btn yellow" onmousedown="event.preventDefault(); toggleHighlight('yellow')" title="ë…¸ë€ í˜•ê´‘íœ"></button>
                <button class="hl-btn green" onmousedown="event.preventDefault(); toggleHighlight('green')" title="ì—°ë‘ í˜•ê´‘íœ"></button>
            </div>


  <!-- âœ… ì—¬ê¸° ì¶”ê°€ -->
  <div class="tb-divider"></div>

  <button class="tool-btn font-btn" onmousedown="event.preventDefault(); applyFontSize('0.9rem')">A-</button>
  <button class="tool-btn font-btn" onmousedown="event.preventDefault(); applyFontSize('1.1rem')">A</button>
  <button class="tool-btn font-btn" onmousedown="event.preventDefault(); applyFontSize('1.3rem')">A+</button>
</div>

            
            <div style="padding:0 1.5rem 1.5rem; flex:1; display:flex; flex-direction:column; overflow:hidden;">
                <div class="input-group">
                    <label style="font-size:0.85rem; font-weight:700; color:#64748b; display:block; margin-bottom:0.5rem;">ğŸ”‘ í‚¤ì›Œë“œ / ì•”ê¸°ë²•</label>
                    <div id="modal-editor-key" class="rich-editor" contenteditable="true" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
                </div>
                <div class="input-group" style="flex:1; display:flex; flex-direction:column; overflow:hidden; margin-top:1rem;">
                    <label style="font-size:0.85rem; font-weight:700; color:#64748b; display:block; margin-bottom:0.5rem;">ğŸ“ ìƒì„¸ í•´ì„¤</label>
                    <div id="modal-editor-val" class="rich-editor detail" contenteditable="true" placeholder="ìƒì„¸ í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
                </div>
            </div>
            <input type="hidden" id="modal-field-key">
            <div style="padding:1rem; border-top:1px solid #e2e8f0;">
                <button class="btn" onclick="saveFieldData()">ì €ì¥ ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="manager-preview-modal">
        <div class="modal-content" style="position:relative;">
            <div id="edit-help-overlay" onclick="closeEditHelp()">
                <div style="margin-top:4rem; text-align:left;">
                    <div class="edit-help-arrow">â¬†ï¸</div>
                    <div class="edit-help-text">
                        ì¹´ë“œ ë’·ë©´ì— í¬í•¨ë  í•­ëª©ì„<br>ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                    <div class="edit-help-arrow" style="margin-top:2rem;">â¬‡ï¸</div>
                    <div class="edit-help-text">
                        ê° í•­ëª©ì„ ëˆŒëŸ¬<br>ë‚˜ë§Œì˜ ì•”ê¸°ë²•ê³¼ í•´ì„¤ì„<br>ì‘ì„±í•˜ì„¸ìš”.
                    </div>
                    <div style="margin-top:auto; text-align:center; color:#cbd5e1; font-weight:400; font-size:0.9rem;">
                        (í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤)
                    </div>
                </div>
            </div>

            <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <span style="font-weight:700;" id="manager-preview-title">ì¹´ë“œ í¸ì§‘</span>
                    <button class="icon-btn delete" style="width:28px; height:28px;" onclick="deleteCardData(editTargetId)">
                        <svg style="width:1.2rem; height:1.2rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                <button onclick="document.getElementById('manager-preview-modal').classList.remove('open')" style="font-size:1.5rem; background:none; border:none;">&times;</button>
            </div>
            <div class="chip-container" id="preview-chips">
                <div class="field-chip active" onclick="toggleField(this, 'C')">C</div>
                <div class="field-chip active" onclick="toggleField(this, 'A')">A</div>
                <div class="field-chip active" onclick="toggleField(this, 'F')">F</div>
                <div class="field-chip active" onclick="toggleField(this, 'PEx')">PEx</div>
                <div class="field-chip active" onclick="toggleField(this, 'Edu')">Edu</div>
                <div class="field-chip active" onclick="toggleField(this, 'Memo')">Memo</div>
            </div>
            <div class="cpx-form" id="manager-preview-form" style="padding:1.5rem;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="timer-modal">
        <div class="modal-content" style="height:auto; min-height:30%;">
            <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700;">íƒ€ì´ë¨¸ ì„¤ì •</span>
                <button onclick="closeTimerModal()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
            </div>
            <div style="padding:1.5rem;">
                <button class="timer-option-btn" onclick="setTimerOption('1min')">1ë¶„ ì—°ìŠµ <span style="font-weight:400; color:#64748b;">60ì´ˆ</span></button>
                <button class="timer-option-btn" onclick="setTimerOption('unlimited')">ë¬´ì œí•œ <span style="font-weight:400; color:#64748b;">&infin;</span></button>
                <button class="timer-option-btn" onclick="setTimerOption('custom')">ì§ì ‘ ì…ë ¥</button>
            </div>
        </div>
    </div>
 
    <div class="modal-overlay" id="onboarding-modal">
        <div class="modal-content" style="background:white; position:relative;">
            <button class="onboarding-close" onclick="closeOnboarding()">&times;</button>
            
            <div class="onboarding-slider" id="onboard-slider"></div>
            
            <div class="onboarding-nav">
                <div class="dots" id="onboard-dots"></div> <button class="btn" style="width:auto; padding:0.8rem 1.5rem;" id="onboard-next-btn" onclick="nextSlide()">ë‹¤ìŒ</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- DATA & LOGIC ---

// 1. ë„ì›€ë§ ë°ì´í„° (ìƒˆë¡œ ì¶”ê°€í•œ ê²ƒ)
const ONBOARDING_DATA = [
    {
        type: 'image', src: 'icon.PNG', color: '',
        title: 'ì‹œê°„ê³¼ ì¥ì†Œë¥¼<br>ê°€ë¦¬ì§€ ì•ŠëŠ” 1ë¶„ í›ˆë ¨',
        desc: `ì§§ì€ ì‹œê°„ ì•ˆì— ì£¼ì†Œ(C.C)ë¥¼ ë³´ê³ <br><b>Associated Sx</b>ë¶€í„° <b>PEx</b>ê¹Œì§€<br>1ë¶„ ì•ˆì— ë– ì˜¬ë¦¬ëŠ” ì—°ìŠµì„ ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.<br><br><span style="font-size: 0.8rem; color: #94a3b8;">Created by <b>KNU FM JSW</b></span>`,
        extra: `<div class="warn-box">âš ï¸ <b>ì£¼ì˜:</b> ì•„ì§ ë³¸ê²©ì ì¸ <b>ì‹¤ê¸° ëŒ€ë¹„ 1íšŒì°¨ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ë‹¤ë©´</b> í° ë„ì›€ì´ ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>`
    }, 
    {
        type: 'svg', color: '#2563eb',
        path: `<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>`,
        title: 'ì˜¤ëŠ˜ì˜ ê³µë¶€ë¥¼ ë³µìŠµí•˜ì„¸ìš”',
        desc: `í•™ìŠµëª¨ë“œì—ì„œ ì œí•œ ì‹œê°„ê³¼ ìˆœì„œë¥¼ ì„¤ì •í•´ ë¬´ì‘ìœ„ ì¦ë¡€ë¥¼ í•™ìŠµí•©ë‹ˆë‹¤.<br>ì¹´ë“œ ë’·ë©´ì—ì„œ ë°”ë¡œ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
        extra: `<div class="tip-box">ğŸ’¡ <b>Tip:</b> 1íšŒì°¨ ì—°ìŠµì„ ëŒë©´ì„œ,<br><b>ê·¸ë‚  ì§„í–‰í–ˆë˜ ì£¼ì œë¥¼ ë³µìŠµ</b>í•˜ëŠ” ìš©ë„ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><circle cx="15.5" cy="15.5" r="1.5"></circle>`,
        title: 'ì‹¤ì „ ê°ê° í‚¤ìš°ê¸°',
        desc: `í€´ì¦ˆëª¨ë“œì—ì„œ ì›í•˜ëŠ” ê³„í†µê³¼ ë¬¸ì œ ìˆ˜ë¥¼ ì„¤ì •í•´ ë¬´ì‘ìœ„ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.`,
        extra: `<div class="tip-box">ğŸ’¡ <b>Tip:</b> ì „ì²´ íšŒë…ì´ ëë‚œ<br><b>2íšŒì°¨ ì´í›„ë¶€í„°</b>, ì „ ë²”ìœ„ë¥¼ ì„ íƒí•´ ì‹¤ë ¥ì„ ìœ ì§€í•˜ì„¸ìš”.</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>`,
        title: 'ë‚˜ë§Œì˜ ì•”ê¸°ë²• ì™„ì„±',
        desc: `í•œë, ìœ ë‹ˆì˜¨, ì•Œë Œ... ë‹¤ì–‘í•œ ì•”ê¸°ë²• ì¤‘<br>ëª©ë¡ì—ì„œ <b>ì—°í•„ ì•„ì´ì½˜(âœï¸)</b>ì„ ëˆŒëŸ¬<br>ë‚´ ì…ì— ë§ëŠ” í‚¤ì›Œë“œë¥¼ ì ì–´ë‘ì„¸ìš”.<br>ì¹´ë©”ë¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ í¸í•˜ê²Œ ì…ë ¥ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤!`,
        extra: `<div class="tip-box">ğŸ’¡ <b>Tip:</b> ì§€ê¸ˆ ë°”ë¡œ ëª©ë¡ìœ¼ë¡œ ê°€ì„œ,<br><b>ì˜¤ëŠ˜ ê³µë¶€í•œ ì£¼ì œë¶€í„°</b> ì •ë¦¬ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><path d="M12 14v-4m0 0l-2 2m2-2l2 2" stroke="#2563eb"></path>`,
        title: 'ì•±ì²˜ëŸ¼ ì„¤ì¹˜í•˜ì„¸ìš”',
        desc: `ë§¤ë²ˆ ì£¼ì†Œë¥¼ ì…ë ¥í•  í•„ìš” ì—†ì´<br><b>'í™ˆ í™”ë©´ì— ì¶”ê°€'</b>ë¥¼ í•´ë³´ì„¸ìš”.<br>ì§„ì§œ ì–´í”Œì²˜ëŸ¼ ì•„ì´ì½˜ì´ ìƒê¹ë‹ˆë‹¤!`,
        extra: `<div class="tip-box" style="text-align:left; font-size:0.85rem;">ğŸ <b>iOS(Safari):</b><br>í•˜ë‹¨ ê³µìœ  ë²„íŠ¼(ë„¤ëª¨+í™”ì‚´í‘œ) â†’ <b>'í™ˆ í™”ë©´ì— ì¶”ê°€'</b><br><br>ğŸ¤– <b>Android(Chrome):</b><br>ìƒë‹¨ ë©”ë‰´(ì  3ê°œ) â†’ <b>'í™ˆ í™”ë©´ì— ì¶”ê°€'</b> (ë˜ëŠ” ì•± ì„¤ì¹˜)</div>`
    },
    {
        type: 'svg', color: '#ef4444',
        path: `<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>`,
        title: 'ë°ì´í„° ë°±ì—… & ì£¼ì˜ì‚¬í•­',
        desc: `ëª©ë¡ íƒ­ í•˜ë‹¨ì˜ <b>[ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°]</b>ë¥¼ í†µí•´<br>ì•„ì´í°â†”ì•„ì´íŒ¨ë“œâ†”PC ê°„ ë°ì´í„°ë¥¼<br>ììœ ë¡­ê²Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
        extra: `<div class="warn-box" style="text-align:center; font-size:0.9rem;">ğŸš¨ <b>ë§¤ìš° ì¤‘ìš”!</b><br>ì´ ì•±ì€ ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤.<br><b>'ì¸í„°ë„· ì‚¬ìš© ê¸°ë¡(ìºì‹œ) ì‚­ì œ'</b>ë¥¼ í•˜ë©´<br>ì‘ì„±í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br><b>ê¼­! ìˆ˜ì‹œë¡œ ë°±ì—… ì½”ë“œë¥¼ ë³µì‚¬í•´ë‘ì„¸ìš”.</b></div>`
    }
];

// 2. ì£¼ì œ ë°ì´í„° (ì›ë˜ ìˆë˜ ê²ƒ)
const TOPICS = [
    {id:1, cat:"ì†Œí™”ê¸°", title:"01. ê¸‰ì„± ë³µí†µ"}, {id:2, cat:"ì†Œí™”ê¸°", title:"02. ì†Œí™”ë¶ˆëŸ‰/ë§Œì„± ë³µí†µ"}, {id:3, cat:"ì†Œí™”ê¸°", title:"03. í† í˜ˆ"},
    {id:4, cat:"ì†Œí™”ê¸°", title:"04. í˜ˆë³€"}, {id:5, cat:"ì†Œí™”ê¸°", title:"05. êµ¬í† "}, {id:6, cat:"ì†Œí™”ê¸°", title:"06-1. ë°°ë³€ ì´ìƒ(ë³€ë¹„)"},
    {id:57, cat:"ì†Œí™”ê¸°", title:"06-2. ë°°ë³€ ì´ìƒ(ì„¤ì‚¬)"}, {id:7, cat:"ì†Œí™”ê¸°", title:"07. í™©ë‹¬"}, {id:8, cat:"ìˆœí™˜ê¸°", title:"08. ê°€ìŠ´ í†µì¦"},
    {id:9, cat:"ìˆœí™˜ê¸°", title:"09. ì‹¤ì‹ "}, {id:10, cat:"ìˆœí™˜ê¸°", title:"10. ë‘ê·¼ê±°ë¦¼"}, {id:11, cat:"ìˆœí™˜ê¸°", title:"11. ê³ í˜ˆì••"},
    {id:12, cat:"ìˆœí™˜ê¸°", title:"12. ì´ìƒì§€ì§ˆí˜ˆì¦"}, {id:13, cat:"í˜¸í¡ê¸°", title:"13. ê¸°ì¹¨"}, {id:14, cat:"í˜¸í¡ê¸°", title:"14. ì½§ë¬¼/ì½”ë§‰í˜"},
    {id:15, cat:"í˜¸í¡ê¸°", title:"15. ê°í˜ˆ"}, {id:16, cat:"í˜¸í¡ê¸°", title:"16. í˜¸í¡ê³¤ë€"}, {id:17, cat:"ì‹ ì¥/ë¹„ë‡¨", title:"17-1. ì†Œë³€ëŸ‰ ë³€í™”(ë‹¤ë‡¨ì¦)"},
    {id:58, cat:"ì‹ ì¥/ë¹„ë‡¨", title:"17-2. ì†Œë³€ëŸ‰ ë³€í™”(í•ë‡¨)"}, {id:18, cat:"ì‹ ì¥/ë¹„ë‡¨", title:"18. ë¶‰ì€ìƒ‰ ì†Œë³€"}, {id:19, cat:"ì‹ ì¥/ë¹„ë‡¨", title:"19-1. ë°°ë‡¨ ì´ìƒ"},
    {id:59, cat:"ì‹ ì¥/ë¹„ë‡¨", title:"19-2. ì†Œë³€ì°”ë”ì¦"}, {id:20, cat:"ì „ì‹ ", title:"20. ë°œì—´"}, {id:21, cat:"ì „ì‹ ", title:"21. ì‰½ê²Œ ë©ì´ ë“¦"},
    {id:22, cat:"ì „ì‹ ", title:"22. í”¼ë¡œ"}, {id:23, cat:"ì „ì‹ ", title:"23. ì²´ì¤‘ ê°ì†Œ"}, {id:24, cat:"ì „ì‹ ", title:"24. ì²´ì¤‘ ì¦ê°€/ë¹„ë§Œ"},
    {id:25, cat:"ê´€ì ˆ/ê·¼ê³¨ê²©/í”¼ë¶€", title:"25. ê´€ì ˆ í†µì¦/ë¶€ê¸°"}, {id:26, cat:"ê´€ì ˆ/ê·¼ê³¨ê²©/í”¼ë¶€", title:"26-1. ëª© í†µì¦"}, {id:60, cat:"ê´€ì ˆ/ê·¼ê³¨ê²©/í”¼ë¶€", title:"26-2. í—ˆë¦¬ í†µì¦"},
    {id:27, cat:"ê´€ì ˆ/ê·¼ê³¨ê²©/í”¼ë¶€", title:"27. í”¼ë¶€ ë°œì§„"}, {id:28, cat:"ì •ì‹ /ì‹ ê²½", title:"28. ê¸°ë¶„ ë³€í™”"}, {id:29, cat:"ì •ì‹ /ì‹ ê²½", title:"29. ë¶ˆì•ˆ"},
    {id:30, cat:"ì •ì‹ /ì‹ ê²½", title:"30. ìˆ˜ë©´ì¥ì• "}, {id:31, cat:"ì •ì‹ /ì‹ ê²½", title:"31. ê¸°ì–µë ¥ ì €í•˜"}, {id:32, cat:"ì •ì‹ /ì‹ ê²½", title:"32. ì–´ì§€ëŸ¼"},
    {id:33, cat:"ì •ì‹ /ì‹ ê²½", title:"33. ë‘í†µ"}, {id:34, cat:"ì •ì‹ /ì‹ ê²½", title:"34. ê²½ë ¨"}, {id:35, cat:"ì •ì‹ /ì‹ ê²½", title:"35. ê·¼ë ¥/ê°ê° ì´ìƒ"},
    {id:36, cat:"ì •ì‹ /ì‹ ê²½", title:"36. ì˜ì‹ì¥ì• "}, {id:37, cat:"ì •ì‹ /ì‹ ê²½", title:"37. ë–¨ë¦¼/ìš´ë™ ì´ìƒ"}, {id:38, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"38. ìœ ë°©í†µ/ìœ ë°©ë©ì´"},
    {id:39, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"39-1. ì§ˆë¶„ë¹„ë¬¼"}, {id:61, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"39-2. ì§ˆì¶œí˜ˆ"}, {id:40, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"40-1. ì›”ê²½ ì´ìƒ"},
    {id:62, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"40-2. ì›”ê²½í†µ"}, {id:41, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"41. ì‚°ì „ ì§„ì°°"}, {id:42, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"42-1. ì„±ì¥ ì§€ì—°"},
    {id:63, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"42-2. ë°œë‹¬ ì§€ì—°"}, {id:43, cat:"ì‚°ë¶€/ì—¬ì„±/ì†Œì•„", title:"43. ì˜ˆë°©ì ‘ì¢…"}, {id:44, cat:"ìƒë‹´", title:"44-1. ìŒì£¼ ìƒë‹´"},
    {id:64, cat:"ìƒë‹´", title:"44-2. ê¸ˆì—° ìƒë‹´"}, {id:45, cat:"ìƒë‹´", title:"45. ë¬¼ì§ˆ ì˜¤ë‚¨ìš©"}, {id:46, cat:"ìƒë‹´", title:"46. ë‚˜ìœ ì†Œì‹ ì „í•˜ê¸°"},
    {id:47, cat:"ìƒë‹´", title:"47-1. ê°€ì • í­ë ¥"}, {id:65, cat:"ìƒë‹´", title:"47-2. ì„± í­ë ¥"}, {id:48, cat:"ìƒë‹´", title:"48. ìì‚´"}
];

const NAMES_L = ['ê¹€','ì´','ë°•','ìµœ','ì •','ê°•','ì¡°','ìœ¤','ì¥','ì„'];
const NAMES_M = ['ì² ìˆ˜','ë¯¼ìˆ˜','ì˜í˜¸','ì¤€í˜¸','ìƒì² ','ì„±í˜¸','ë™í˜„','ì¬ìš°'];
const NAMES_F = ['ì˜í¬','ë¯¸ì˜','ì§€ì€','ìˆ˜ì§„','í˜œì§„','ì •ìˆ™','ë¯¼ì§€','í˜„ì£¼'];
const ALL_FIELDS = ['C','A','F','PEx','Edu','Memo'];

function getRandomInt(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }
function getRandomItem(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
function getNormalVitals() {
    return {
        bp: `${getRandomInt(100,135)}/${getRandomInt(60,85)}`,
        hr: `${getRandomInt(60,95)}íšŒ`,
        rr: `${getRandomInt(14,20)}íšŒ`,
        bt: `36.${getRandomInt(3,7)}â„ƒ`
    };
}

const HYBRID_SKILLS = {
    3: ["í˜ˆì•• ì¸¡ì •ì„ ì‹œí–‰í•˜ì‹œì˜¤.", "ì •ë§¥ ì£¼ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤.", "ì•ˆì „ìˆ˜í˜ˆìˆ ê¸°ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."],
    4: ["í•­ë¬¸ ì§ì¥ ì§„ì°°ì„ ì‹œí–‰í•˜ì‹œì˜¤.", "í˜ˆì•• ì¸¡ì •ì„ ì‹œí–‰í•˜ì‹œì˜¤.", "ì •ë§¥ ì£¼ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤.", "ì•ˆì „ìˆ˜í˜ˆìˆ ê¸°ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."],
    5: ["ì •ë§¥ ì£¼ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."], 6: ["í•­ë¬¸ ì§ì¥ ì§„ì°°ì„ ì‹œí–‰í•˜ì‹œì˜¤."], 57: ["ì •ë§¥ ì£¼ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."],
    7: ["ë™ë§¥í˜ˆ ì±„í˜ˆì„ ì‹œí–‰í•˜ì‹œì˜¤."], 9: ["í˜ˆì•• ì¸¡ì •ì„ ì‹œí–‰í•˜ì‹œì˜¤."], 11: ["í˜ˆì•• ì¸¡ì •ì„ ì‹œí–‰í•˜ì‹œì˜¤."],
    13: ["ë™ë§¥í˜ˆ ì±„í˜ˆì„ ì‹œí–‰í•˜ì‹œì˜¤."], 15: ["ì•ˆì „ìˆ˜í˜ˆìˆ ê¸°ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."], 20: ["í˜ˆì•¡ ë°°ì–‘ì„ ìœ„í•œ ì±„í˜ˆì„ ì‹œí–‰í•˜ì‹œì˜¤."],
    21: ["ì•ˆì „ìˆ˜í˜ˆìˆ ê¸°ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."], 32: ["ì´ê²½ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤.", "í˜ˆì•• ì¸¡ì •ì„ ì‹œí–‰í•˜ì‹œì˜¤.", "ì•ˆì € ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."],
    62: ["ìê¶ê²½ë¶€ í´ë°”ë¦„ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤.", "ì§ˆ ë¶„ë¹„ë¬¼ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."], 40: ["ìê¶ê²½ë¶€ í´ë°”ë¦„ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤.", "ì§ˆ ë¶„ë¹„ë¬¼ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."],
    41: ["ë¶„ë§Œ ì§„í–‰ ë‹¨ê³„ ì§„ì°°ì„ ì‹œí–‰í•˜ì‹œì˜¤.", "ìê¶ê²½ë¶€ í´ë°”ë¦„ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤.", "ì§ˆ ë¶„ë¹„ë¬¼ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."], 65: ["ì§ˆ ë¶„ë¹„ë¬¼ ê²€ì‚¬ë¥¼ ì‹œí–‰í•˜ì‹œì˜¤."]
};

// ì¦ë¡€ ìƒì„±ê¸° (ì†Œì•„ê³¼ í‘œí˜„ ê°œì„  ë²„ì „)
// ì¦ë¡€ ìƒì„±ê¸° ("í™˜ì•„" í‘œí˜„ ì‚­ì œ ë²„ì „)
function generateCase(card) {
    let title = card.title;
    let isMale = Math.random() > 0.5;
    let age = getRandomInt(20, 75);
    let name = getRandomItem(NAMES_L) + (isMale ? getRandomItem(NAMES_M) : getRandomItem(NAMES_F));
    let scenario = "";
    let vitals = getNormalVitals();
    let instructions = ["ì¦ìƒê³¼ ê´€ë ¨ëœ ë³‘ë ¥ì„ ì²­ì·¨í•˜ê³ ,", "ì ì ˆí•œ ì‹ ì²´ì§„ì°°ì„ ì‹œí–‰í•œ í›„,", "ì¶”ì •ì§„ë‹¨ê³¼ í–¥í›„ ê³„íšì„ í™˜ìì™€ ë…¼ì˜í•˜ì‹œì˜¤."];
    
    // ì†Œì•„ ì—¬ë¶€ í”Œë˜ê·¸
    let isChild = false; 

    switch(card.id) {
        case 1: scenario = "ë°°ê°€ ì•„íŒŒ ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 2: scenario = getRandomItem(["ë°°ê°€ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ì†Œí™”ê°€ ë˜ì§€ ì•Šì•„ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 3: scenario = "í”¼ë¥¼ í† í•´ ë‚´ì›í•˜ì˜€ë‹¤." + (Math.random()>0.7?" (í˜„ì¬ ì‘ê¸‰ì‹¤, ì•„ì¹¨ 9ì‹œ)":""); if(scenario.includes("ì‘ê¸‰ì‹¤")) { vitals.hr = "110íšŒ"; vitals.bp = "90/60"; } break;
        case 4: scenario = getRandomItem(["í˜ˆë³€ì„ ë³¸ë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤.", "ë³€ì—ì„œ í”¼ê°€ ë‚˜ì™”ë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤." + (Math.random()>0.7?" (í˜„ì¬ ì‘ê¸‰ì‹¤)":"")]); break;
        case 5: scenario = Math.random()>0.5 ? "êµ¬í† ë¥¼ í–ˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤." : "êµ¬í† ë¥¼ ì‹¬í•˜ê²Œ í•´ì„œ ì‘ê¸‰ì‹¤ë¡œ ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 6: isMale=false; scenario = "ë³€ë¹„ê°€ ìˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 57: scenario = "ì„¤ì‚¬ë¥¼ í•œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 7: scenario = "ëˆˆì´ ë…¸ë˜ì¡Œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 8: scenario = "ê°€ìŠ´ì´ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 9: scenario = getRandomItem(["ì˜ì‹ì„ ìƒì—ˆë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤.", "ì“°ëŸ¬ì¡Œë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤.", "ê¸°ì ˆí–ˆë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤.", "ì‹¤ì‹ ì„ í–ˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 10: scenario = getRandomItem(["ê°€ìŠ´ì´ ë‘ê·¼ê±°ë¦°ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ë‘ê·¼ê±°ë¦¬ëŠ” ì¦ìƒìœ¼ë¡œ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 11: age=62; scenario = "í˜ˆì••ì´ ë†’ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; vitals.bp = "150/95"; break;
        case 12: scenario = getRandomItem(["ì½œë ˆìŠ¤í…Œë¡¤ ìˆ˜ì¹˜ê°€ ë†’ì•„ ë‚´ì›í•˜ì˜€ë‹¤.", "ì§€ë°© ìˆ˜ì¹˜ê°€ ë†’ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 13: scenario = "ê¸°ì¹¨ì„ í•œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 14: scenario = "ì½§ë¬¼ì´ ë‚œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 15: scenario = "ëª©ì—ì„œ í”¼ê°€ ë‚œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 16: scenario = Math.random()>0.5 ? "ìˆ¨ì´ ì°¬ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤." : "ìˆ¨ì´ ì°¨ì„œ ì‘ê¸‰ì‹¤ë¡œ ë‚´ì›í•˜ì˜€ë‹¤."; if(scenario.includes("ì‘ê¸‰ì‹¤")) vitals.rr = "28íšŒ"; break;
        case 17: scenario = "ì†Œë³€ëŸ‰ì´ ë§ì•„ì¡Œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 58: scenario = "ì†Œë³€ëŸ‰ì´ ì¤„ì–´ë“¤ì—ˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 18: scenario = "ì†Œë³€ìƒ‰ì´ ë¶‰ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 19: scenario = getRandomItem(["ì†Œë³€ì„ ë³¼ ë•Œ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ì†Œë³€ ë³´ëŠ” ê²Œ ë¶ˆí¸í•´ ë‚´ì›í•˜ì˜€ë‹¤.", "ì†Œë³€ì„ ìì£¼ ë´ì„œ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 59: scenario = "ì†Œë³€ì´ ìƒŒë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 20: scenario = "ì—´ì´ ë‚œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; vitals.bt = "38.2â„ƒ"; vitals.hr = "105íšŒ"; break;
        case 21: scenario = getRandomItem(["ë‹¤ë¦¬ì— ë­ê°€ ìƒê¸´ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "í”¼ë¶€ì— ë°˜ì ì´ ìƒê²¨ ë‚´ì›í•˜ì˜€ë‹¤.", "ë©ì´ ì˜ ë“¤ì–´ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 22: scenario = "í”¼ê³¤í•´ì„œ ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 23: scenario = "ì‚´ì´ ë¹ ì§„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 24: scenario = "ì‚´ì´ ì°ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 25: scenario = getRandomItem(["ì†ì´ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ë°œê°€ë½ì´ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ì–´ê¹¨ê°€ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ë¬´ë¦ì´ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 26: scenario = "ëª©ì´ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 60: scenario = "í—ˆë¦¬ê°€ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 27: scenario = getRandomItem(["í”¼ë¶€ì— ë­ê°€ ë‚¬ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "í”¼ë¶€ ë°œì§„ìœ¼ë¡œ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 28: scenario = "ìš°ìš¸í•˜ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 29: scenario = "ë¶ˆì•ˆí•˜ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 30: scenario = "ì ì„ ëª» ìê² ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 31: age=getRandomInt(65,80); scenario = "ê¸°ì–µë ¥ì´ ë–¨ì–´ì¡Œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 32: scenario = "ì–´ì§€ëŸ½ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 33: scenario = "ë¨¸ë¦¬ê°€ ì•„í”„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 34: if(Math.random()>0.5) { isChild=true; age="12ê°œì›”"; isMale=true; name="ë°•ë¡œí•˜"; scenario="ê²½ë ¨ì„ í•œë‹¤ë©° ë³´í˜¸ìì™€ í•¨ê»˜ ì‘ê¸‰ì‹¤ë¡œ ë‚´ì›í•˜ì˜€ë‹¤."; } else { scenario = "ê²½ë ¨ì„ í–ˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; } break;
        case 35: scenario = getRandomItem(["íŒ”ë‹¤ë¦¬ì— í˜ì´ ë¹ ì§„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "íŒ”ì— í˜ì´ ë¹ ì§„ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 36: scenario = getRandomItem(["ì“°ëŸ¬ì¡Œë‹¤ë©° ì‘ê¸‰ì‹¤ë¡œ ë‚´ì›í•˜ì˜€ë‹¤.", "ì˜ì‹ì´ ë–¨ì–´ì ¸ ë³´í˜¸ìì™€ í•¨ê»˜ ì‘ê¸‰ì‹¤ë¡œ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 37: scenario = "ì†ì´ ë–¨ë¦°ë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 38: isMale=false; scenario = getRandomItem(["ìœ ë°© í†µì¦ì„ í˜¸ì†Œí•˜ë©° ë‚´ì›í•˜ì˜€ë‹¤.", "ìœ ë°©ì—ì„œ ë©ì´ê°€ ë§Œì ¸ì ¸ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 39: isMale=false; scenario = getRandomItem(["ëƒ‰ì´ ë§ì•„ì ¸ ë‚´ì›í•˜ì˜€ë‹¤.", "ì§ˆë¶„ë¹„ë¬¼ì´ ìˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 61: isMale=false; scenario = "ì§ˆì¶œí˜ˆì´ ìˆì–´ì„œ ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 40: isMale=false; scenario = getRandomItem(["ì›”ê²½ì„ ì•ˆ í•´ì„œ ë‚´ì›í•˜ì˜€ë‹¤.", "ì›”ê²½ëŸ‰ì´ ë§ì•„ì¡Œë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 62: isMale=false; age=20; scenario = "ì›”ê²½í†µì´ ìˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 41: isMale=false; age=getRandomInt(28,35); scenario = getRandomItem(["ì‚°ì „ì§„ì°°ì„ ìœ„í•´ ë‚´ì›í•˜ì˜€ë‹¤.", "êµ¬í†  ë•Œë¬¸ì— ë‚´ì›í•˜ì˜€ë‹¤.", "ì§ˆ ì¶œí˜ˆ ë•Œë¬¸ì— ë‚´ì›í•˜ì˜€ë‹¤.", "ë³µí†µ ë•Œë¬¸ì— ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        
        // --- ğŸ‘¶ ì†Œì•„ê³¼ íŒŒíŠ¸ (ìˆ˜ì •ë¨) ---
        case 42: // ì„±ì¥ ì§€ì—°
            isChild = true; 
            isMale = false; 
            age = 5; 
            name = "ê¹€ë¯¼ì§€"; 
            scenario = "í‚¤ê°€ ì‘ë‹¤ë©° ë³´í˜¸ìì™€ í•¨ê»˜ ë‚´ì›í•˜ì˜€ë‹¤."; 
            instructions = ["ì„±ì¥ê³¼ ê´€ë ¨ëœ ë³‘ë ¥ì„ ì²­ì·¨í•˜ê³ ,", "ì„±ì¥ê³¡ì„ ì„ ì°¸ê³ í•˜ì—¬ ì¶”ì •ì§„ë‹¨ê³¼ í–¥í›„ ê³„íšì„ ë…¼ì˜í•˜ì‹œì˜¤."]; 
            break;
            
        case 63: // ë°œë‹¬ ì§€ì—°
            isChild = true; 
            isMale = true; 
            age = "30ê°œì›”"; 
            name = "ì´ì˜ìš°"; 
            scenario = "ì•„ì´ ë°œë‹¬ì´ ëŠë¦° ê²ƒ ê°™ë‹¤ë©° ë³´í˜¸ìì™€ í•¨ê»˜ ë‚´ì›í•˜ì˜€ë‹¤."; 
            instructions = ["ë°œë‹¬ê³¼ ê´€ë ¨ëœ ë³‘ë ¥ì„ ì²­ì·¨í•˜ê³ ,", "ì„±ì¥ê³¡ì„ ì„ ì°¸ê³ í•˜ì—¬ ì¶”ì •ì§„ë‹¨ê³¼ í–¥í›„ ê³„íšì„ ë…¼ì˜í•˜ì‹œì˜¤."]; 
            break;
            
        case 43: // ì˜ˆë°©ì ‘ì¢…
            isChild = true; 
            isMale = false;
            let baby = getRandomItem([{a:"7ê°œì›”", n:"ê¹€ë¯¼ì£¼"}, {a:"18ê°œì›”", n:"ìœ¤ì„œí¬"}]);
            age = baby.a; 
            name = baby.n; 
            scenario = "ì˜ˆë°©ì ‘ì¢… ìƒë‹´ì„ ìœ„í•´ ë³´í˜¸ìì™€ í•¨ê»˜ ë‚´ì›í•˜ì˜€ë‹¤."; 
            instructions = ["ì˜ˆë°© ì ‘ì¢… ìˆ˜ì²©ì„ í™•ì¸í•˜ê³ , í•„ìš”í•œ ë³‘ë ¥ì„ ì²­ì·¨í•˜ê³ ,", "í™˜ìì—ê²Œ í•„ìš”í•œ ì˜ˆë°©ì ‘ì¢…ì„ ìƒë‹´í•˜ê³ ,", "ì˜ˆë°© ìˆ˜ì²©ì— ê¸ˆì¼ ì ‘ì¢… í•­ëª©ì— ë‚ ì§œì™€ ë³‘ì›ì„ ê¸°ì…í•˜ì‹œì˜¤."]; 
            break;
            
        case 44: scenario = "ìˆ ì„ ëŠê³  ì‹¶ë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 64: scenario = "ë‹´ë°°ë¥¼ ëŠê³  ì‹¶ë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 45: scenario = "ë¨¹ë˜ ì•½ì„ ì²˜ë°©ë°›ê¸° ìœ„í•´ ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 46: scenario = "ë‘ ë‹¬ ì „ë¶€í„° ì†Œí™”ë¶ˆëŸ‰ì´ ìˆì–´ ìœ„ë‚´ì‹œê²½ ë° CTë¥¼ ì‹œí–‰í•˜ì˜€ìœ¼ë©°, ê²°ê³¼ í™•ì¸ì°¨ ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 47: isMale=false; scenario = getRandomItem(["ë©ì´ ë“¤ì—ˆë‹¤ê³  ë‚´ì›í•˜ì˜€ë‹¤.", "ì „ì‹ ì´ ì•„í”„ê³  ìš°ìš¸í•˜ì—¬ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
        case 65: isMale=false; age=22; scenario = "ì„± í­ë ¥ì„ ë‹¹í–ˆë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤."; break;
        case 48: scenario = getRandomItem(["ì£½ê³  ì‹¶ë‹¤ëŠ” ìƒê°ì´ ë“ ë‹¤ë©° ë‚´ì›í•˜ì˜€ë‹¤.", "ìì‚´ì„ ì‹œë„í•´ì„œ ë‚´ì›í•˜ì˜€ë‹¤."]); break;
    }

    // --- ë¬¸ì¥ ì¡°ë¦½ ë¡œì§ ("í™˜ì•„" ì‚­ì œ ë²„ì „) ---
    let subject = "";
    
    if (isChild) {
        // ì†Œì•„: ë‚˜ì´(ê°œì›”/ì‚´) + ì„±ë³„(ë‚¨ì•„/ì—¬ì•„) + ì´ë¦„ + ê°€ ("í™˜ì•„" ì‚­ì œ)
        let ageStr = (typeof age === 'number') ? age + "ì„¸" : age; 
        let genderStr = isMale ? "ë‚¨ì•„" : "ì—¬ì•„";
        // ë³€ê²½: "í™˜ì•„ê°€" -> "ê°€"
        subject = `${ageStr} ${genderStr} ${name}ê°€`;
    } else {
        // ì„±ì¸: ë‚˜ì´(ì„¸) + ì„±ë³„(ë‚¨ì/ì—¬ì) + ì´ë¦„ + ì”¨ê°€
        subject = `${age}ì„¸ ${isMale?'ë‚¨ì':'ì—¬ì'} ${name}ì”¨ê°€`;
    }

    let caseData = { 
        title: card.title, 
        scenario: `${subject} ${scenario}`, 
        vitalsData: vitals, 
        instructions: instructions 
    };
    
    if (HYBRID_SKILLS[card.id]) { 
        caseData.instructions.splice(2, 0, `<span class="hybrid-skill">${getRandomItem(HYBRID_SKILLS[card.id])}</span>`); 
    }
    
    return caseData;
}

// GLOBAL
let cards = [], userData = {}, studyDeck = [], mockResults = [], currentIndex = 0, timerTime = 60, timeLeft = 60, timerInterval = null, isInfinite = false, collapsedCategories = {}, isShuffle = false, editTargetId = null, currentMode = 'study', currentSlide = 0;

function init() {
    console.log("%c 1ë¶„ CPX v1.2 \n%c OCR Enabled ", "color: white; background: #2563eb; padding: 5px; border-radius: 4px;", "color: #2563eb; background: white; padding: 5px;");
    const savedCards = localStorage.getItem('cpx_v37_cards');
    if(savedCards) cards = JSON.parse(savedCards); else { cards = TOPICS.map(t => ({...t, isVisible: true})); saveCards(); }
    const savedUser = localStorage.getItem('cpx_v37_userdata'); if(savedUser) userData = JSON.parse(savedUser);
    const savedCats = localStorage.getItem('cpx_v37_cats'); if(savedCats) collapsedCategories = JSON.parse(savedCats);
    const savedShuffle = localStorage.getItem('cpx_v38_shuffle'); isShuffle = savedShuffle !== null ? JSON.parse(savedShuffle) : false;
    
    updateShuffleUI();
    startSession('init_silent');
    switchMode('manager');

    // ONBOARDING
    const introSeen = localStorage.getItem('cpx_v5_onboarding_seen');
    if(!introSeen) showOnboarding(false);

    document.getElementById('onboard-slider').addEventListener('scroll', function() {
        const index = Math.round(this.scrollLeft / this.offsetWidth);
        if(currentSlide !== index) { currentSlide = index; setTimeout(updateDotsOnly, 100); }
    });

    document.addEventListener('keydown', (e) => {
        if(document.getElementById('input-modal').classList.contains('open')) return;
        if(document.getElementById('study-view').classList.contains('active')) {
            const wrapper = document.getElementById('card-wrapper');
            const isBack = wrapper.classList.contains('flipped');
            if(currentMode === 'review') {
                if(e.key === "ArrowLeft" || e.key === "Escape") returnToResults();
                else if(e.key === "ArrowUp" || e.key === "ArrowDown") flipCard(!isBack);
                return;
            }
            if(isBack) {
                if(e.key === "ArrowLeft") handleAnswer(false);
                else if(e.key === "ArrowRight") handleAnswer(true);
                else if(e.key === "ArrowUp" || e.key === "ArrowDown") flipCard(false);
            } else {
                if (e.key === "ArrowLeft") prevCard();
                else if (e.key === "ArrowRight") nextCard();
                else if (e.key === "ArrowUp" || e.key === "ArrowDown") flipCard(true);
            }
        }
    });
}

function saveCards() { localStorage.setItem('cpx_v37_cards', JSON.stringify(cards)); }
function saveUserData() { localStorage.setItem('cpx_v37_userdata', JSON.stringify(userData)); }
function saveCats() { localStorage.setItem('cpx_v37_cats', JSON.stringify(collapsedCategories)); }

// ONBOARDING
function renderOnboarding() {
    const slider = document.getElementById('onboard-slider');
    const dotsContainer = document.getElementById('onboard-dots');
    
    // ì´ë¯¸ ë Œë”ë§ ë˜ì–´ìˆìœ¼ë©´ ë¦¬ì…‹
    slider.innerHTML = '';
    dotsContainer.innerHTML = '';

    ONBOARDING_DATA.forEach((slide, index) => {
        // 1. ìŠ¬ë¼ì´ë“œ ìƒì„±
        const div = document.createElement('div');
        div.className = 'onboarding-slide';
        
        let iconHtml = '';
        if(slide.type === 'image') {
            iconHtml = `<img src="${slide.src}" style="width:6rem; height:6rem; border-radius:1.2rem; box-shadow:0 8px 16px -4px rgba(0,0,0,0.15);">`;
        } else {
            iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="${slide.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:5rem; height:5rem;">${slide.path}</svg>`;
        }

        div.innerHTML = `
            <div class="slide-icon">${iconHtml}</div>
            <div class="slide-title">${slide.title}</div>
            <div class="slide-desc">
                ${slide.desc}
                ${slide.extra ? slide.extra : ''}
            </div>
        `;
        slider.appendChild(div);

        // 2. ì (Dot) ìƒì„±
        const dot = document.createElement('div');
        dot.className = 'dot';
        dotsContainer.appendChild(dot);
    });
}

function showOnboarding(force) {
    if(force || !localStorage.getItem('cpx_v5_onboarding_seen')) {
        renderOnboarding(); // ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ í™”ë©´ ê·¸ë¦¬ê¸°
        currentSlide = 0;
        const slider = document.getElementById('onboard-slider');
        slider.scrollLeft = 0;
        updateDotsOnly();
        document.getElementById('onboarding-modal').classList.add('open');
    }
}

function closeOnboarding() {
    localStorage.setItem('cpx_v5_onboarding_seen', 'true');
    document.getElementById('onboarding-modal').classList.remove('open');
}

function nextSlide() {
    if(currentSlide < ONBOARDING_DATA.length - 1) {
        currentSlide++;
        const slider = document.getElementById('onboard-slider');
        slider.scrollTo({left: slider.offsetWidth * currentSlide, behavior: 'smooth'});
        setTimeout(updateDotsOnly, 300);
    } else {
        closeOnboarding();
    }
}

function updateDotsOnly() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));
    
    const btn = document.getElementById('onboard-next-btn');
    // ë°ì´í„° ê°œìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ˆì§€ë§‰ í˜ì´ì§€ íŒë‹¨
    if (currentSlide === ONBOARDING_DATA.length - 1) {
        btn.innerText = "1ë¶„ CPX ì‹œì‘í•˜ê¸°";
    } else {
        btn.innerText = "ë‹¤ìŒ";
    }
}

// EDIT HELP
function checkEditHelp() {
    if(!localStorage.getItem('cpx_edit_help_seen')) { document.getElementById('edit-help-overlay').style.display = 'flex'; }
}
function closeEditHelp() { document.getElementById('edit-help-overlay').style.display = 'none'; localStorage.setItem('cpx_edit_help_seen', 'true'); }

// REST OF LOGIC
function toggleShuffle() {
    isShuffle = !isShuffle; localStorage.setItem('cpx_v38_shuffle', JSON.stringify(isShuffle)); updateShuffleUI();
    if(studyDeck.length > 0 && currentMode === 'study') {
        const played = studyDeck.slice(0, currentIndex); const current = studyDeck[currentIndex]; let remaining = studyDeck.slice(currentIndex + 1);
        if(isShuffle) { for (let i = remaining.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [remaining[i], remaining[j]] = [remaining[j], remaining[i]]; } showToast("ğŸ”€ ë‚¨ì€ ì¹´ë“œê°€ ì„ì˜€ìŠµë‹ˆë‹¤"); } 
        else { remaining.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0)); showToast("ğŸ”¢ ë‚¨ì€ ì¹´ë“œê°€ ì •ë ¬ë©ë‹ˆë‹¤"); }
        studyDeck = [...played, current, ...remaining];
    }
}
function updateShuffleUI() { document.getElementById('btn-shuffle').classList.toggle('active', isShuffle); }
function startSession(mode) {
    if(mode === 'reset' && !confirm("í˜„ì¬ ì§„í–‰ìƒí™©ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒìœ¼ë¡œ ë˜ëŒë¦¬ê² ìŠµë‹ˆê¹Œ?")) return;
    currentMode = 'study'; let tempDeck = cards.filter(c => c.isVisible);
    if(isShuffle) { for (let i = tempDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [tempDeck[i], tempDeck[j]] = [tempDeck[j], tempDeck[i]]; } } 
    else { tempDeck.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0)); }
    studyDeck = tempDeck; currentIndex = 0;
    if(mode !== 'init_silent') { switchMode('study'); renderCard(); if(mode === 'reset') showToast("í•™ìŠµì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); }
}
function renderCard() {
    const wrapper = document.getElementById('card-wrapper'); const emptyState = document.getElementById('empty-state');
    const navRow = document.getElementById('front-nav'); const ansBtns = document.getElementById('answer-btns'); const reviewNav = document.getElementById('review-nav');
    wrapper.classList.remove('shaking');
    if(studyDeck.length === 0 || currentIndex >= studyDeck.length) {
        if(currentMode === 'mock') { showMockResult(); } else { wrapper.style.display = 'none'; document.querySelector('.controls').style.display = 'none'; emptyState.style.display = 'block'; stopTimer(); } return;
    }
    wrapper.style.display = 'block'; document.querySelector('.controls').style.display = 'block'; emptyState.style.display = 'none'; wrapper.classList.remove('flipped');
    navRow.style.display = 'none'; ansBtns.style.display = 'none'; reviewNav.style.display = 'none';
    if(currentMode === 'review') reviewNav.style.display = 'grid'; else navRow.style.display = 'flex';
    const card = studyDeck[currentIndex]; const data = generateCase(card); const frontEl = document.getElementById('card-front');
    frontEl.innerHTML = `<div class="topic-badge">${data.title}</div><div class="info-box"><div class="info-label">ìƒí™© ì§€ì¹¨</div><div class="info-content">${data.scenario}</div></div><div class="info-box"><div class="vitals-container"><div class="vital-item"><span class="vital-label">í˜ˆì••</span><span class="vital-value">${data.vitalsData.bp}</span></div><div class="vital-item"><span class="vital-label">ë§¥ë°•</span><span class="vital-value">${data.vitalsData.hr}</span></div><div class="vital-item"><span class="vital-label">í˜¸í¡</span><span class="vital-value">${data.vitalsData.rr}</span></div><div class="vital-item"><span class="vital-label">ì²´ì˜¨</span><span class="vital-value">${data.vitalsData.bt}</span></div></div></div><div class="info-box"><div class="info-label">ì§€ì‹œì‚¬í•­ : ì‘ì‹œìëŠ” ì´ í™˜ìì—ê²Œ</div><ul class="instruction-list">${data.instructions.map(i => `<li>${i}</li>`).join('')}</ul></div><div class="touch-hint"><span class="pc-hint">âŒ¨ï¸ ìœ„/ì•„ë˜ í‚¤ or </span>ğŸ‘† í„°ì¹˜í•˜ì—¬ ì •ë‹µ í™•ì¸</div>`;
    renderBack(card, 'card-back-form');
    document.getElementById('progress-text').innerText = `${currentIndex+1} / ${studyDeck.length}`; document.getElementById('progress-fill').style.width = `${((currentIndex)/studyDeck.length)*100}%`;
    stopTimer(); if(!isInfinite) { timeLeft = timerTime; startTimer(); } else updateTimerUI();
}
function renderBack(card, targetId) {
    const container = document.getElementById(targetId); const uData = userData[card.id] || {}; const activeFields = uData.activeFields || ALL_FIELDS; let formHtml = '';
    activeFields.forEach(code => {
        const key = uData[code+'_k'] || ''; const val = uData[code+'_v'] || '';
        formHtml += `<div class="field-group"><div class="field-header" onclick="toggleExpl(this)"><div class="field-label">${code}</div><div class="field-key ${!key ? 'empty' : ''}">${key || '(ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...)'}</div></div><div class="explanation-box" onclick="openModal('${code}')">${val || '<span style="color:#cbd5e1">(í•´ì„¤ì„ ì…ë ¥í•˜ë ¤ë©´ ì—¬ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”)</span>'}</div></div>`;
    });
    if(activeFields.length === 0) formHtml = '<div style="padding:1rem; color:#94a3b8; text-align:center;">ì„ íƒëœ ì–‘ì‹ì´ ì—†ìŠµë‹ˆë‹¤.<br>í¸ì§‘ì—ì„œ ì¹©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
    container.innerHTML = formHtml;
}
function flipCard(isBack) {
    const wrapper = document.getElementById('card-wrapper'); const frontNav = document.getElementById('front-nav'); const ansBtns = document.getElementById('answer-btns');
    if(isBack) { wrapper.classList.add('flipped'); stopTimer(); wrapper.classList.remove('shaking'); if(currentMode !== 'review') { frontNav.style.display = 'none'; ansBtns.style.display = 'grid'; } } 
    else { wrapper.classList.remove('flipped'); startTimer(); if(currentMode !== 'review') { frontNav.style.display = 'flex'; ansBtns.style.display = 'none'; } }
}
function handleAnswer(isCorrect) {
    const cId = studyDeck[currentIndex].id; if(!userData[cId]) userData[cId] = {};
    if(isCorrect) userData[cId].o = (userData[cId].o || 0) + 1; else userData[cId].x = (userData[cId].x || 0) + 1;
    saveUserData(); if(currentMode === 'mock') mockResults.push({ id: cId, result: isCorrect });
    currentIndex++; renderCard();
}
function prevCard() { if(currentIndex>0) { currentIndex--; renderCard(); } else showToast("ì²« ë²ˆì§¸ ì¹´ë“œì…ë‹ˆë‹¤."); }
function nextCard() { if(currentIndex<studyDeck.length-1) { currentIndex++; renderCard(); } else showToast("ë§ˆì§€ë§‰ ì¹´ë“œì…ë‹ˆë‹¤."); }
function hideCurrentCard() {
    const card = studyDeck[currentIndex]; const realIdx = cards.findIndex(c => c.id === card.id);
    if(realIdx > -1) { cards[realIdx].isVisible = false; saveCards(); studyDeck.splice(currentIndex, 1); showToast("ìˆ¨ê²¨ì¡ŒìŠµë‹ˆë‹¤."); if(currentIndex >= studyDeck.length) currentIndex = Math.max(0, studyDeck.length - 1); renderCard(); }
}
function deleteCardData(id) {
    if(!confirm("ì´ ì¹´ë“œì— ì‘ì„±í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    delete userData[id]; saveUserData(); renderBack(cards.find(c => c.id === id), 'manager-preview-form'); showToast("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
}
function toggleExpl(el) { el.nextElementSibling.classList.toggle('show'); }
function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1500); }
function switchMode(mode) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.header-btn').forEach(el => el.classList.remove('active'));
    const btnReset = document.getElementById('btn-reset'); const btnShuffle = document.getElementById('btn-shuffle');
    if(mode === 'study') { document.getElementById('study-view').classList.add('active'); document.getElementById('btn-mode-study').classList.add('active'); btnReset.style.display = 'flex'; btnShuffle.style.display = 'flex'; if(studyDeck.length > 0) renderCard(); }
    else if (mode === 'manager') { document.getElementById('manager-view').classList.add('active'); document.getElementById('btn-mode-list').classList.add('active'); btnReset.style.display = 'none'; btnShuffle.style.display = 'none'; stopTimer(); renderManager(); }
    else if (mode.startsWith('mock')) { document.getElementById('btn-mode-mock').classList.add('active'); btnReset.style.display = 'none'; btnShuffle.style.display = 'none';
        if(mode === 'mock-setup') { document.getElementById('mock-setup-view').classList.add('active'); renderMockTree(); } else if(mode === 'mock-result') { document.getElementById('mock-result-view').classList.add('active'); } stopTimer();
    }
}
/* â–¼â–¼â–¼ íŒŒë€ ì—°í•„ ê¸°ëŠ¥ì´ ë³µêµ¬ëœ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ â–¼â–¼â–¼ */
function renderManager() {
    const list = document.getElementById('list-container'); 
    list.innerHTML = ''; 
    const groups = {}; 
    cards.forEach(c => { if(!groups[c.cat]) groups[c.cat] = []; groups[c.cat].push(c); });
    
    const allVisible = cards.every(c => c.isVisible); 
    const toggleBtn = document.getElementById('btn-toggle-all'); 
    toggleBtn.innerHTML = allVisible ? 'â ì „ì²´ í•´ì œ' : 'â˜‘ï¸ ì „ì²´ ì„ íƒ'; 
    toggleBtn.onclick = () => toggleAllCards(!allVisible);
    
    for(const [cat, items] of Object.entries(groups)) {
        const allHidden = items.every(c => !c.isVisible); 
        const catDiv = document.createElement('div'); 
        catDiv.className = 'category-section'; 
        items.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0));
        
        const isCollapsed = collapsedCategories[cat];
        
        catDiv.innerHTML = `<div class="category-header" onclick="toggleCatCollapse('${cat}')"><span>${cat} (${items.length}) ${isCollapsed?'â–¼':'â–²'}</span><button class="icon-action-btn ${!allHidden?'active':''}" onclick="event.stopPropagation(); toggleCategory('${cat}')">${!allHidden ? '<svg style="width:1.2rem; height:1.2rem" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : '<svg style="width:1.2rem; height:1.2rem" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'}</button></div><div class="category-list ${isCollapsed ? 'collapsed' : ''}">${items.map(c => { 
            
            // âœï¸ [ë³µêµ¬ë¨] ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§
            const u = userData[c.id] || {}; 
            const hasContent = Object.keys(u).some(k => k.endsWith('_v') && u[k] && u[k].replace(/<[^>]*>/g, '').trim().length > 0);
            
            const total = (u.o||0) + (u.x||0); 
            let badgeClass = 'score-gray'; 
            if(total > 0) { const rate = (u.o||0) / total; if(rate >= 0.8) badgeClass = 'score-green'; else if(rate >= 0.5) badgeClass = 'score-yellow'; else badgeClass = 'score-red'; } 
            const badgeText = total > 0 ? total : '-'; 
            
            // âœï¸ ë²„íŠ¼ í´ë˜ìŠ¤ì— ${hasContent ? 'filled' : ''} ì¶”ê°€ë¨
            return `<div class="list-item ${!c.isVisible ? 'hidden' : ''}"><div class="item-left"><span class="title">${c.title}</span></div><div class="item-right"><span class="score-badge ${badgeClass}">${badgeText}</span><div class="list-actions"><button class="icon-action-btn edit ${hasContent ? 'filled' : ''}" onclick="openManagerCardPreview(${c.id})"><svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button class="icon-action-btn ${c.isVisible?'active':''}" onclick="toggleCard(${c.id})">${c.isVisible ? '<svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>' : '<svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>'}</button></div></div></div>`; }).join('')}</div>`; list.appendChild(catDiv);
    }
}
function toggleCatCollapse(cat) { collapsedCategories[cat] = !collapsedCategories[cat]; saveCats(); renderManager(); }
function toggleCard(id) { const c = cards.find(x => x.id === id); if(c) { c.isVisible = !c.isVisible; saveCards(); renderManager(); } }
function toggleCategory(cat) { const items = cards.filter(c => c.cat === cat); const newState = !items.some(c => c.isVisible); items.forEach(c => c.isVisible = newState); saveCards(); renderManager(); }
function toggleAllCards(state) { cards.forEach(c => c.isVisible = state); saveCards(); renderManager(); }
function renderMockTree() { const root = document.getElementById('mock-tree-root'); root.innerHTML = ''; const groups = {}; cards.forEach(c => { if(!groups[c.cat]) groups[c.cat] = []; groups[c.cat].push(c); }); for(const [cat, items] of Object.entries(groups)) { items.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0)); const catDiv = document.createElement('div'); catDiv.className = 'tree-cat'; const checkedCount = items.filter(c => c.isVisible).length; catDiv.innerHTML = `<div class="tree-cat-head" onclick="toggleTreeCat(this)"><input type="checkbox" class="tree-chk-cat" onclick="event.stopPropagation(); checkCat(this)" ${checkedCount>0?'checked':''}><label>${cat} (${items.length})</label><span style="font-size:0.8rem; color:#cbd5e1;">â–¼</span></div><div class="tree-items">${items.map(c => `<div class="tree-item"><input type="checkbox" class="tree-chk-item" value="${c.id}" ${c.isVisible?'checked':''}><label onclick="this.previousElementSibling.click()">${c.title}</label></div>`).join('')}</div>`; root.appendChild(catDiv); } }
function toggleTreeCat(el) { el.nextElementSibling.classList.toggle('open'); el.querySelector('span').innerText = el.nextElementSibling.classList.contains('open') ? 'â–²' : 'â–¼'; }
function checkCat(el) { el.parentElement.nextElementSibling.querySelectorAll('.tree-chk-item').forEach(i => i.checked = el.checked); }
function toggleAllMockTree() { const all = document.querySelectorAll('#mock-tree-root input[type="checkbox"]'); const state = Array.from(all).some(c => !c.checked); all.forEach(c => c.checked = state); }
function startMockExam() { const chks = document.querySelectorAll('.tree-chk-item:checked'); if(chks.length === 0) { alert("ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; } const num = parseInt(document.getElementById('mock-num').value) || 5; const selectedIds = Array.from(chks).map(c => parseInt(c.value)); const selectedCards = cards.filter(c => selectedIds.includes(c.id)); const cats = {}; selectedCards.forEach(c => { if(!cats[c.cat]) cats[c.cat] = []; cats[c.cat].push(c); }); let pool = []; const catKeys = Object.keys(cats).sort(() => Math.random() - 0.5); catKeys.forEach(k => { if(cats[k].length > 0) { const idx = Math.floor(Math.random() * cats[k].length); pool.push(cats[k][idx]); cats[k].splice(idx, 1); } }); let remaining = num - pool.length; let leftovers = []; Object.values(cats).forEach(arr => leftovers.push(...arr)); if(remaining > 0 && leftovers.length > 0) { leftovers.sort(() => Math.random() - 0.5); pool.push(...leftovers.slice(0, remaining)); } else if (remaining < 0) { pool = pool.slice(0, num); } pool.sort(() => Math.random() - 0.5); currentMode = 'mock'; studyDeck = pool; currentIndex = 0; mockResults = []; document.getElementById('study-view').classList.add('active'); document.getElementById('mock-setup-view').classList.remove('active'); renderCard(); showToast(`${pool.length}ë¬¸ì œ í€´ì¦ˆ ì‹œì‘!`); }
function showMockResult() { 
    switchMode('mock-result'); 
    const correctCount = mockResults.filter(r => r.result).length; 
    const total = mockResults.length;
    const score = Math.round((correctCount / total) * 100);
    
    document.getElementById('result-score-text').innerText = `${correctCount} / ${total}`;
    
    let msg = "ì˜í–ˆì–´ìš”!";
    if(score === 100) msg = "ğŸ‰ ì™„ë²½í•´ìš”! ëª¨ë“  ë¬¸ì œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!";
    else if(score >= 80) msg = "ğŸ‘ ì•„ì£¼ í›Œë¥­í•´ìš”! ì¡°ê¸ˆë§Œ ë” í•˜ë©´ ë§Œì !";
    else if(score >= 50) msg = "ğŸ’ª í˜ë‚´ì„¸ìš”! ì˜¤ë‹µì„ ê¼­ ë³µìŠµí•˜ì„¸ìš”.";
    else msg = "ğŸ”¥ ë” ë¶„ë°œí•´ì•¼ í•´ìš”! ê¸°ë³¸ê¸°ë¥¼ ë‹¤ì ¸ë³´ì„¸ìš”.";
    document.getElementById('result-msg').innerText = msg;

    const hasWrong = total - correctCount > 0;
    document.getElementById('retry-wrong-btn-area').style.display = hasWrong ? 'block' : 'none';

    document.getElementById('result-list').innerHTML = mockResults.map(r => { const c = cards.find(x => x.id === r.id); return `<div class="result-item" onclick="reviewMockCard(${c.id})"><span class="res-badge ${r.result?'res-o':'res-x'}">${r.result?'O':'X'}</span><span style="flex:1; font-weight:600;">${c.title}</span><span style="color:#cbd5e1;">&gt;</span></div>`; }).join(''); 
}
function retryWrongAnswers() {
    const wrongIds = mockResults.filter(r => !r.result).map(r => r.id);
    if(wrongIds.length === 0) return;
    const pool = cards.filter(c => wrongIds.includes(c.id));
    currentMode = 'mock'; studyDeck = pool; currentIndex = 0; mockResults = [];
    document.getElementById('study-view').classList.add('active'); document.getElementById('mock-result-view').classList.remove('active');
    renderCard(); showToast(`${pool.length}ë¬¸ì œ ì¬ë„ì „ ì‹œì‘!`);
}
function reviewMockCard(id) { const c = cards.find(x => x.id === id); currentMode = 'review'; studyDeck = [c]; currentIndex = 0; switchMode('study'); renderCard(); }
function returnToResults() { switchMode('mock-result'); }
function openManagerCardPreview(id) { editTargetId = id; const card = cards.find(c => c.id === id); document.getElementById('manager-preview-title').innerText = card.title; const uData = userData[id] || {}; const active = uData.activeFields || ALL_FIELDS; document.querySelectorAll('.field-chip').forEach(chip => chip.classList.toggle('active', active.includes(chip.innerText))); renderBack(card, 'manager-preview-form'); document.getElementById('manager-preview-modal').classList.add('open'); checkEditHelp(); }
function toggleField(chip, code) { chip.classList.toggle('active'); const uData = userData[editTargetId] || {}; let active = uData.activeFields || [...ALL_FIELDS]; if(chip.classList.contains('active')) { if(!active.includes(code)) active.push(code); } else { active = active.filter(x => x !== code); } active.sort((a,b) => ALL_FIELDS.indexOf(a) - ALL_FIELDS.indexOf(b)); if(!userData[editTargetId]) userData[editTargetId] = {}; userData[editTargetId].activeFields = active; saveUserData(); renderBack(cards.find(c => c.id === editTargetId), 'manager-preview-form'); }
function openModal(code) { const isManager = document.getElementById('manager-preview-modal').classList.contains('open'); if(!isManager) editTargetId = studyDeck[currentIndex].id; const uData = userData[editTargetId] || {}; document.getElementById('modal-field-key').value = code; document.getElementById('modal-editor-key').innerHTML = uData[code+'_k'] || ''; document.getElementById('modal-editor-val').innerHTML = uData[code+'_v'] || ''; document.getElementById('input-modal').classList.add('open'); }
function closeModal() { document.getElementById('input-modal').classList.remove('open'); }
function execCmd(cmd) { document.execCommand(cmd, false, null); }
function execColor(color) { document.execCommand('foreColor', false, color); }


// í°íŠ¸ ì‚¬ì´ì¦ˆ js

function applyFontSize(size) {
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return;

  const range = sel.getRangeAt(0);
  if (range.collapsed) return;

  const span = document.createElement('span');
  span.style.fontSize = size;

  range.surroundContents(span);

  sel.removeAllRanges();
  sel.addRange(range);
}


    
// âœ… í˜•ê´‘íœ í† ê¸€ (ê°™ì€ ìƒ‰ì´ë©´ ì œê±°, ë‹¤ë¥¸ ìƒ‰ì´ë©´ ì ìš©/ë³€ê²½)
function toggleHighlight(color) {
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return;

  const range = sel.getRangeAt(0);
  if (range.collapsed) return;

  const COLORS = {
    yellow: '#fff9c4',
    green:  '#dcedc8'
  };
  const targetColor = COLORS[color] || COLORS.yellow;

  // ë¸Œë¼ìš°ì €ë³„ ì§€ì›: hiliteColorê°€ ì•ˆ ë˜ë©´ backColor ì‚¬ìš© (íŠ¹íˆ Safari ëŒ€ì‘)
  const cmd = document.queryCommandSupported && document.queryCommandSupported('hiliteColor')
    ? 'hiliteColor'
    : 'backColor';

  // í˜„ì¬ ì„ íƒì˜ì—­ì´ "ê°™ì€ ìƒ‰ í˜•ê´‘íœ" ìœ„ì— ìˆëŠ”ì§€ íŒë‹¨
  const isSame = selectionHasSameBgColor(sel, targetColor);

  if (isSame) {
    // âœ… ê°™ì€ ìƒ‰ì´ë©´ "ì œê±°" (íˆ¬ëª…ìœ¼ë¡œ ì¹ í•œ ë’¤, ë¶ˆí•„ìš” span ì •ë¦¬)
    document.execCommand(cmd, false, 'transparent');
    cleanupTransparentHighlightSpans(getClosestEditable(sel.anchorNode));
  } else {
    // âœ… ì•„ë‹ˆë©´ ì ìš©/ë³€ê²½
    document.execCommand(cmd, false, targetColor);
  }
}

// ---- í—¬í¼ë“¤ ----

function selectionHasSameBgColor(sel, targetHex) {
  const targetRgb = toRgb(targetHex);

  const a = nearestBgSpan(sel.anchorNode);
  const b = nearestBgSpan(sel.focusNode);

  // anchor/focus ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ê°™ì€ ìƒ‰ì´ë©´ "ê°™ì€ ìƒ‰ìœ¼ë¡œ ì¹ í•´ì§„ ìƒíƒœ"ë¡œ ê°„ì£¼
  return (a && colorsEqual(getComputedStyle(a).backgroundColor, targetRgb)) ||
         (b && colorsEqual(getComputedStyle(b).backgroundColor, targetRgb));
}

function nearestBgSpan(node) {
  let el = node && node.nodeType === Node.ELEMENT_NODE ? node : node?.parentElement;
  while (el && el !== document.body) {
    if (el.nodeType === 1) {
      const bg = getComputedStyle(el).backgroundColor;
      if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') return el;
    }
    el = el.parentElement;
  }
  return null;
}

function toRgb(colorStr) {
  const tmp = document.createElement('span');
  tmp.style.backgroundColor = colorStr;
  document.body.appendChild(tmp);
  const rgb = getComputedStyle(tmp).backgroundColor;
  document.body.removeChild(tmp);
  return rgb;
}

function colorsEqual(a, b) {
  // ê³µë°± ì°¨ì´ ë“±ë§Œ ì •ë¦¬í•´ì„œ ë¹„êµ
  return String(a).replace(/\s+/g, '') === String(b).replace(/\s+/g, '');
}

function getClosestEditable(node) {
  let el = node && node.nodeType === Node.ELEMENT_NODE ? node : node?.parentElement;
  while (el && el !== document.body) {
    if (el.isContentEditable) return el;
    el = el.parentElement;
  }
  return document.body;
}

function cleanupTransparentHighlightSpans(root) {
  // transparent/rgba(0,0,0,0) ê°™ì€ spanë“¤ ì •ë¦¬(ê»ë°ê¸°ë§Œ ë‚¨ëŠ” ê±° ë°©ì§€)
  const spans = root.querySelectorAll('span');
  spans.forEach(span => {
    const bg = getComputedStyle(span).backgroundColor;
    if (bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
      // span í’€ê¸°
      const parent = span.parentNode;
      while (span.firstChild) parent.insertBefore(span.firstChild, span);
      parent.removeChild(span);
    }
  });
}

function saveFieldData() { 
    const code = document.getElementById('modal-field-key').value; 
    if(!userData[editTargetId]) userData[editTargetId] = {}; 
    userData[editTargetId][code+'_k'] = document.getElementById('modal-editor-key').innerHTML; 
    userData[editTargetId][code+'_v'] = document.getElementById('modal-editor-val').innerHTML; 
    
    saveUserData(); 
    
    // ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
    if(document.getElementById('manager-preview-modal').classList.contains('open')) renderBack(cards.find(c => c.id === editTargetId), 'manager-preview-form'); 
    // í•™ìŠµ ëª¨ë“œ ê°±ì‹ 
    if(document.getElementById('study-view').classList.contains('active') && studyDeck[currentIndex] && studyDeck[currentIndex].id === editTargetId) renderBack(studyDeck[currentIndex], 'card-back-form'); 
    
    // âœ… [ì¶”ê°€ë¨] ëª©ë¡ í™”ë©´ë„ ì¦‰ì‹œ ê°±ì‹  (íŒŒë€ ì—°í•„ ë°”ë¡œ ë°˜ì˜)
    if(document.getElementById('manager-view').classList.contains('active')) renderManager();

    closeModal(); 
    showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
}
// --- ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° (í´ë¦½ë³´ë“œ ë°©ì‹) ---

// 1. ë‚´ë³´ë‚´ê¸° (ë³µì‚¬í•˜ê¸°)
async function exportDataToClipboard() {
    const backupData = {
        cards: cards,
        userData: userData,
        cats: collapsedCategories,
        date: new Date().toLocaleString()
    };

    const jsonString = JSON.stringify(backupData);

    try {
        await navigator.clipboard.writeText(jsonString);
        alert("ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¹´ì¹´ì˜¤í†¡ì´ë‚˜ ë©”ëª¨ì¥ì— 'ë¶™ì—¬ë„£ê¸°'í•˜ì—¬ ë³´ê´€í•˜ì„¸ìš”.");
    } catch (err) {
        const textArea = document.getElementById('import-text-area');
        textArea.value = jsonString;
        document.querySelector('details').open = true;
        textArea.select();
        alert("ìë™ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì•„ë˜ í…ìŠ¤íŠ¸ ìƒìì˜ ë‚´ìš©ì„ 'ì „ì²´ ì„ íƒ' -> 'ë³µì‚¬' í•˜ì„¸ìš”.");
    }
}

// 2. ê°€ì ¸ì˜¤ê¸° (ë¶™ì—¬ë„£ê¸° - ìë™)
async function importDataFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        if (!text) {
            alert("í´ë¦½ë³´ë“œì— ë³µì‚¬ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        processDataRestoration(text);
    } catch (err) {
        console.error(err);
        document.querySelector('details').open = true;
        document.getElementById('import-text-area').focus();
        alert("í´ë¦½ë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nì•„ë˜ ì…ë ¥ì°½ì— ë°±ì—… ì½”ë“œë¥¼ ì§ì ‘ ë¶™ì—¬ë„£ê³  'í…ìŠ¤íŠ¸ë¡œ ë³µì›í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    }
}

// 3. ê°€ì ¸ì˜¤ê¸° (ìˆ˜ë™ ì…ë ¥ì°½ ì‚¬ìš©)
function importFromTextArea() {
    const text = document.getElementById('import-text-area').value;
    if (!text.trim()) {
        alert("ë°±ì—… ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    processDataRestoration(text);
}

// 4. ì‹¤ì œ ë°ì´í„° ë³µì› ë¡œì§
function processDataRestoration(jsonString) {
    try {
        const data = JSON.parse(jsonString);
        if (!data.cards || !data.userData) {
            throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
        }
        if (confirm(`ë°±ì—… ë°ì´í„°(${data.date || 'ë‚ ì§œ ì—†ìŒ'})ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì§„í–‰ ìƒí™©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`)) {
            cards = data.cards;
            userData = data.userData;
            collapsedCategories = data.cats || {};
            saveCards();
            saveUserData();
            saveCats();
            alert("âœ… ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }
    } catch (e) {
        console.error(e);
        alert("ë°ì´í„° ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¬ë°”ë¥¸ ë°±ì—… ì½”ë“œê°€ ì•„ë‹ˆê±°ë‚˜ í˜•ì‹ì´ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
}
function resetData() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°ì´í„° ì‚­ì œ)")) { localStorage.clear(); location.reload(); } }
function openTimerModal() { document.getElementById('timer-modal').classList.add('open'); }
function closeTimerModal() { document.getElementById('timer-modal').classList.remove('open'); }
function setTimerOption(mode) { if(mode==='1min') { timerTime=60; isInfinite=false; } else if(mode==='unlimited') isInfinite=true; else { const v=prompt("ì‹œê°„(ì´ˆ):", "60"); if(v) {timerTime=parseInt(v); isInfinite=false;} } stopTimer(); timeLeft=isInfinite?999:timerTime; updateTimerUI(); closeTimerModal(); if(document.getElementById('study-view').classList.contains('active') && studyDeck.length > 0) startTimer(); }
function startTimer() { 
    stopTimer(); 
    if(!isInfinite) timeLeft=timerTime; 
    updateTimerUI; 
    timerInterval = setInterval(() => { 
        if(isInfinite) return; 
        timeLeft--; 
        updateTimerUI(); 
        if(timeLeft<=0) { 
            stopTimer(); 
            document.getElementById('card-wrapper').classList.add('shaking'); 
        } 
    }, 1000); 
}
function stopTimer() { clearInterval(timerInterval); document.getElementById('timer-badge').classList.remove('urgent'); }
function updateTimerUI() { 
    const badge = document.getElementById('timer-badge');
    document.getElementById('timer-text').innerHTML = isInfinite ? '&infin;' : timeLeft; 
    if(!isInfinite && timeLeft <= 10) badge.classList.add('urgent');
    else badge.classList.remove('urgent');
}


init();
</script>
</body>
</html>



